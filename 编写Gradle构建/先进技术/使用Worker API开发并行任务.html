 无标题 <style id="wiz_custom_css">html, .wiz-editor-body {font-size: 12pt;}.wiz-editor-body {font-family: Helvetica, 'Hiragino Sans GB', '微软雅黑', 'Microsoft YaHei UI', SimSun, SimHei, arial, sans-serif;line-height: 1.7;margin: 0 auto;position:relative;padding: 20px 16px;}.wiz-editor-body h1,.wiz-editor-body h2,.wiz-editor-body h3,.wiz-editor-body h4,.wiz-editor-body h5,.wiz-editor-body h6 {margin:20px 0 10px;margin:1.25rem 0 0.625rem;padding: 0;font-weight: bold;}.wiz-editor-body h1 {font-size:20pt;font-size:1.67rem;}.wiz-editor-body h2 {font-size:18pt;font-size:1.5rem;}.wiz-editor-body h3 {font-size:15pt;font-size:1.25rem;}.wiz-editor-body h4 {font-size:14pt;font-size:1.17rem;}.wiz-editor-body h5 {font-size:12pt;font-size:1rem;}.wiz-editor-body h6 {font-size:12pt;font-size:1rem;color: #777777;margin: 1rem 0;}.wiz-editor-body div,.wiz-editor-body p,.wiz-editor-body ul,.wiz-editor-body ol,.wiz-editor-body dl,.wiz-editor-body li {margin:8px 0 0;}.wiz-editor-body blockquote,.wiz-editor-body table,.wiz-editor-body pre,.wiz-editor-body code {margin:8px 0;}.wiz-editor-body .CodeMirror pre {margin:0;}.wiz-editor-body a {word-wrap: break-word;text-decoration-skip-ink: none;}.wiz-editor-body ul,.wiz-editor-body ol {padding-left:32px;padding-left:2rem;}.wiz-editor-body ol.wiz-list-level1 > li {list-style-type:decimal;}.wiz-editor-body ol.wiz-list-level2 > li {list-style-type:lower-latin;}.wiz-editor-body ol.wiz-list-level3 > li {list-style-type:lower-roman;}.wiz-editor-body li.wiz-list-align-style {list-style-position: inside; margin-left: -1em;}.wiz-editor-body blockquote {padding: 0 12px;}.wiz-editor-body blockquote > :first-child {margin-top:0;}.wiz-editor-body blockquote > :last-child {margin-bottom:0;}.wiz-editor-body img {border:0;max-width:100%;height:auto !important;margin:2px 0;padding: 2px;vertical-align:bottom;}.wiz-editor-body table {border-collapse:collapse;border:1px solid #a7afbc;}.wiz-editor-body td,.wiz-editor-body th {padding:4px 8px;border-collapse:collapse;border:1px solid #a7afbc;min-height:28px;word-break:break-word;box-sizing: border-box;}.wiz-editor-body td > div:first-child {margin-top:0;}.wiz-editor-body td > div:last-child {margin-bottom:0;}.wiz-editor-body img.wiz-svg-image {box-shadow:1px 1px 4px #E8E8E8;}.wiz-editor-body .wiz-image-container {margin:0;max-width: 100%;display: inline-flex;flex-direction: column;}.wiz-editor-body .wiz-image-container .wiz-image-title {display:inline-block;text-align: center;color: #a7afbc;line-height: 18px;font-size: 12px;min-height: 18px;width: 100%;white-space: normal;}.wiz-hide {display:none !important;}.wiz-editor-body.wiz-editor-outline {padding-right:0; padding-left:0;}.wiz-editor-body.wiz-editor-outline .outline-container {margin:0; padding:0; line-height:1.5;}.wiz-editor-body.wiz-editor-outline .outline-container div {margin:0;}.wiz-editor-body.wiz-editor-outline .node {margin:0; padding: 0;}.wiz-editor-body.wiz-editor-outline .outline-container > .node {margin-right:24px; margin-left:30px;}.wiz-editor-body.wiz-editor-outline .node.collapsed .children {display:none;}.wiz-editor-body.wiz-editor-outline .node .row {position:relative; padding-left:26px;}.wiz-editor-body.wiz-editor-outline .node .operator-container {width:36px;position:absolute; top:4px; left:-18px;}.wiz-editor-body.wiz-editor-outline .node .operator-bar {position:absolute; top:0; left:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center;}.wiz-editor-body.wiz-editor-outline .node .switch {width:18px; height:18px;display:flex;flex-direction: column;align-items: center;overflow: hidden;}.wiz-editor-body.wiz-editor-outline .node .switch i {font-size:20px;position:relative;left:-1px;top:-1px;}.wiz-editor-body.wiz-editor-outline .node .switch.active {cursor:pointer;color:transparent; transition:transform 200ms ease 0s;}.wiz-editor-body.wiz-editor-outline .node.collapsed .switch.active {transform:rotateZ(-90deg);}.wiz-editor-body.wiz-editor-outline .node .row:hover .switch.active {color:#505F79}.wiz-editor-body.wiz-editor-outline .node .dot {display:flex; align-items:center; justify-content:center; border-radius:100%; width:18px; height:18px;}.wiz-editor-body.wiz-editor-outline .node.collapsed .dot {background-color:rgba(80, 95, 121, .15);}.wiz-editor-body.wiz-editor-outline .node .dot-icon {background-color:#505F79; border-radius:100%; width:6px; height:6px;}.wiz-editor-body.wiz-editor-outline .node .child {margin-left:8px; border-left:1px solid #E6E9ED; padding-left:17px;}.wiz-editor-body.wiz-editor-outline .node .content {flex:1;outline:none; padding:4px 0;}.wiz-editor-body.wiz-editor-outline .node div.content {font-size:1rem;}.wiz-editor-body.wiz-editor-outline .node.complete > .row .content {text-decoration:line-through;color:#A7AFBC;}.wiz-editor-body.wiz-editor-outline .node .notes {outline:none; font-size:.8rem; color:#A7AFBC;}.wiz-editor-body.wiz-editor-outline .node .image {outline:none; padding-top:4px; padding-bottom:4px;}.wiz-editor-body.wiz-editor-outline .outline-container h1,.wiz-editor-body.wiz-editor-outline .outline-container h2,.wiz-editor-body.wiz-editor-outline .outline-container h3,.wiz-editor-body.wiz-editor-outline .outline-container h4,.wiz-editor-body.wiz-editor-outline .outline-container h5,.wiz-editor-body.wiz-editor-outline .outline-container h6 {margin:0;}body, .wiz-editor-body { padding-left: 48px; padding-right: 48px;}</style><style id="wiz_code_style">.wiz-editor-body .wiz-code-container{position: relative; padding:8px 0; margin: 5px 0;text-indent:0; text-align:left;}.CodeMirror {font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace; color: black; font-size: 10.5pt; font-size: 0.875rem}.wiz-editor-body .wiz-code-container .CodeMirror div {margin-top: 0; margin-bottom: 0;}.CodeMirror-lines {padding: 4px 0;}.CodeMirror pre.CodeMirror-line,.CodeMirror pre.CodeMirror-line-like {padding: 0 4px;}.CodeMirror pre.CodeMirror-line {min-height: 24px;}.CodeMirror-scrollbar-filler, .CodeMirror-gutter-filler {background-color: white;}.CodeMirror-gutters {border-right: 1px solid #ddd; background-color: #f7f7f7; white-space: nowrap;}.CodeMirror-linenumbers {}.CodeMirror-linenumber {padding: 0 3px 0 5px; min-width: 20px; text-align: right; color: #999; white-space: nowrap;}.CodeMirror-guttermarker {color: black;}.CodeMirror-guttermarker-subtle {color: #999;}.CodeMirror-cursor {border-left: 1px solid black; border-right: none; width: 0;}.CodeMirror div.CodeMirror-secondarycursor {border-left: 1px solid silver;}.cm-fat-cursor .CodeMirror-cursor {width: auto; border: 0 !important; background: #7e7;}.cm-fat-cursor div.CodeMirror-cursors {z-index: 1;}.cm-fat-cursor-mark {background-color: rgba(20, 255, 20, 0.5);-webkit-animation: blink 1.06s steps(1) infinite;-moz-animation: blink 1.06s steps(1) infinite;animation: blink 1.06s steps(1) infinite;}.cm-animate-fat-cursor {width: auto; border: 0; -webkit-animation: blink 1.06s steps(1) infinite; -moz-animation: blink 1.06s steps(1) infinite; animation: blink 1.06s steps(1) infinite; background-color: #7e7;}@-moz-keyframes blink { 0% {} 50% { background-color: transparent; } 100% {}}@-webkit-keyframes blink { 0% {} 50% { background-color: transparent; } 100% {}}@keyframes blink { 0% {} 50% { background-color: transparent; } 100% {}}.CodeMirror-overwrite .CodeMirror-cursor {}.cm-tab { display: inline-block; text-decoration: inherit; }.CodeMirror-rulers {position: absolute; left: 0; right: 0; top: -50px; bottom: -20px; overflow: hidden;}.CodeMirror-ruler {border-left: 1px solid #ccc; top: 0; bottom: 0; position: absolute;}.cm-s-default .cm-header {color: blue;}.cm-s-default .cm-quote {color: #090;}.cm-negative {color: #d44;}.cm-positive {color: #292;}.cm-header, .cm-strong {font-weight: bold;}.cm-em {font-style: italic;}.cm-link {text-decoration: underline;}.cm-strikethrough {text-decoration: line-through;}.cm-s-default .cm-keyword {color: #708;}.cm-s-default .cm-atom {color: #219;}.cm-s-default .cm-number {color: #164;}.cm-s-default .cm-def {color: #00f;}.cm-s-default .cm-variable,.cm-s-default .cm-punctuation,.cm-s-default .cm-property,.cm-s-default .cm-operator {}.cm-s-default .cm-variable-2 {color: #05a;}.cm-s-default .cm-variable-3 {color: #085;}.cm-s-default .cm-comment {color: #a50;}.cm-s-default .cm-string {color: #a11;}.cm-s-default .cm-string-2 {color: #f50;}.cm-s-default .cm-meta {color: #555;}.cm-s-default .cm-qualifier {color: #555;}.cm-s-default .cm-builtin {color: #30a;}.cm-s-default .cm-bracket {color: #997;}.cm-s-default .cm-tag {color: #170;}.cm-s-default .cm-attribute {color: #00c;}.cm-s-default .cm-hr {color: #999;}.cm-s-default .cm-link {color: #00c;}.cm-s-default .cm-error {color: #f00;}.cm-invalidchar {color: #f00;}.CodeMirror-composing { border-bottom: 2px solid; }div.CodeMirror span.CodeMirror-matchingbracket {color: #0b0;}div.CodeMirror span.CodeMirror-nonmatchingbracket {color: #a22;}.CodeMirror-matchingtag { background: rgba(255, 150, 0, .3); }.CodeMirror-activeline-background {background: #e8f2ff;}.CodeMirror {position: relative; background: #f5f5f5;}.CodeMirror-scroll {overflow: hidden !important; margin-bottom: 0; margin-right: -30px; padding: 16px 30px 16px 0; outline: none; position: relative;}.CodeMirror-sizer {position: relative; border-right: 30px solid transparent;}.CodeMirror-vscrollbar, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-gutter-filler {position: absolute; z-index: 6; display: none;}.CodeMirror-vscrollbar {right: 0; top: 0; overflow-x: hidden; overflow-y: scroll;}.CodeMirror-hscrollbar {bottom: 0; left: 0 !important; overflow-y: hidden; overflow-x: scroll;pointer-events: auto !important;outline: none;}.CodeMirror-scrollbar-filler {right: 0; bottom: 0;}.CodeMirror-gutter-filler {left: 0; bottom: 0;}.CodeMirror-gutters {position: absolute; left: 0; top: 0; min-height: 100%; z-index: 3;}.CodeMirror-gutter {white-space: normal; height: 100%; display: inline-block; vertical-align: top; margin-bottom: -30px;}.CodeMirror-gutter-wrapper {position: absolute; z-index: 4; background: none !important; border: none !important;}.CodeMirror-gutter-background {position: absolute; top: 0; bottom: 0; z-index: 4;}.CodeMirror-gutter-elt {position: absolute; cursor: default; z-index: 4;}.CodeMirror-gutter-wrapper ::selection { background-color: transparent }.CodeMirror-gutter-wrapper ::-moz-selection { background-color: transparent }.CodeMirror-lines {cursor: text; min-height: 1px;}.CodeMirror pre.CodeMirror-line,.CodeMirror pre.CodeMirror-line-like {-moz-border-radius: 0; -webkit-border-radius: 0; border-radius: 0; border-width: 0; background: transparent; font-family: inherit; font-size: inherit; margin: 0; white-space: pre; word-wrap: normal; line-height: inherit; color: inherit; z-index: 2; position: relative; overflow: visible; -webkit-tap-highlight-color: transparent; -webkit-font-variant-ligatures: contextual; font-variant-ligatures: contextual;}.CodeMirror-wrap pre.CodeMirror-line,.CodeMirror-wrap pre.CodeMirror-line-like {word-wrap: break-word; white-space: pre-wrap; word-break: normal;}.CodeMirror-linebackground {position: absolute; left: 0; right: 0; top: 0; bottom: 0; z-index: 0;}.CodeMirror-linewidget {position: relative; z-index: 2; padding: 0.1px;}.CodeMirror-widget {}.CodeMirror-rtl pre { direction: rtl; }.CodeMirror-code {outline: none;}.CodeMirror-scroll,.CodeMirror-sizer,.CodeMirror-gutter,.CodeMirror-gutters,.CodeMirror-linenumber {-moz-box-sizing: content-box; box-sizing: content-box;}.CodeMirror-measure {position: absolute; width: 100%; height: 0; overflow: hidden; visibility: hidden;}.CodeMirror-cursor {position: absolute; pointer-events: none;}.CodeMirror-measure pre { position: static; }div.CodeMirror-cursors {visibility: hidden; position: relative; z-index: 3;}div.CodeMirror-dragcursors {visibility: visible;}.CodeMirror-focused div.CodeMirror-cursors {visibility: visible;}.CodeMirror-selected { background: #d9d9d9; }.CodeMirror-focused .CodeMirror-selected { background: #d7d4f0; }.CodeMirror-crosshair { cursor: crosshair; }.CodeMirror-line::selection, .CodeMirror-line > span::selection, .CodeMirror-line > span > span::selection { background: #d7d4f0; }.CodeMirror-line::-moz-selection, .CodeMirror-line > span::-moz-selection, .CodeMirror-line > span > span::-moz-selection { background: #d7d4f0; }.cm-searching {background: #ffa; background: rgba(255, 255, 0, .4);}.cm-force-border { padding-right: .1px; }@media print { .CodeMirror div.CodeMirror-cursors {visibility: hidden;}}.cm-tab-wrap-hack:after { content: ""; }span.CodeMirror-selectedtext { background: none; }.CodeMirror-activeline-background, .CodeMirror-selected {transition: visibility 0ms 100ms;}.CodeMirror-blur .CodeMirror-activeline-background, .CodeMirror-blur .CodeMirror-selected {visibility:hidden;}.CodeMirror-blur .CodeMirror-matchingbracket {color:inherit !important;outline:none !important;text-decoration:none !important;}.CodeMirror-sizer {min-height:auto !important;}</style>

# 使用Worker API开发并行任务

内容

* [创建一个自定义任务类](https://docs.gradle.org/nightly/userguide/worker_api.html#create_a_custom_task_class)
* [转换为Worker API](https://docs.gradle.org/nightly/userguide/worker_api.html#converting_to_the_worker_api)
* [更改隔离模式](https://docs.gradle.org/nightly/userguide/worker_api.html#changing_the_isolation_mode)
* [创建一个工人守护进程](https://docs.gradle.org/nightly/userguide/worker_api.html#creating_a_worker_daemon)

Worker API提供了将任务动作的执行分解为离散的工作单元，然后同时并异步执行该工作的功能。这使Gradle可以充分利用可用资源并更快地完成构建。本节将引导您完成将现有自定义任务转换为使用Worker API的过程。

本节假定您了解编写Gradle自定义任务的基础。有关该主题的更多信息，请参阅[关于定制任务](https://docs.gradle.org/nightly/userguide/custom_tasks.html)的[部分](https://docs.gradle.org/nightly/userguide/custom_tasks.html)。

您将首先创建一个自定义任务类，该类为可配置文件集生成MD5哈希值。然后，您将转换此自定义任务以使用Worker API。然后，我们将探索以不同级别的隔离度运行任务。在此过程中，您将了解Worker API的基础知识及其提供的功能。

## [](https://docs.gradle.org/nightly/userguide/worker_api.html#create_a_custom_task_class)[创建一个自定义任务类](https://docs.gradle.org/nightly/userguide/worker_api.html#create_a_custom_task_class)

首先，您需要创建一个自定义任务，该任务会生成一组可配置文件的MD5哈希值。

在新目录中，创建一个`buildSrc/build.gradle(.kts)`文件。

`Groovy``Kotlin`

buildSrc / build.gradle

repositories \{ jcenter\(\) \} dependencies \{ implementation 'commons-io:commons-io:2.5' implementation 'commons-codec:commons-codec:1.9' \}

 

1

repositories \{

2

 jcenter\(\)

3

\}

4

5

dependencies \{

6

 implementation 'commons-io:commons-io:2.5'

7

 implementation 'commons-codec:commons-codec:1.9' 

8

\}

<table style="background:none;"><tbody><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="1" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>您的自定义任务类将使用</font></font><a href="https://commons.apache.org/proper/commons-codec/" style="color:rgb(29, 162, 189);text-decoration:none;"><font><font>Apache Commons Codec</font></font></a><font><font>生成MD5哈希。</font></font></td></tr></tbody></table>

<table style="background:none;width:912px;"><tbody><tr><td class="icon" style="color:rgba(0, 0, 0, 0.8);width:80px;"><i class="fa icon-tip"></i></td><td class="content" style="font-size:1.0625rem;color:rgba(0, 0, 0, 0.6);"><font><font>如果您不熟悉</font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">buildSrc</code><font><font>，这是一个特殊目录，可让您定义和构建应在构建脚本中使用的自定义类。</font><font>有关</font><font>更多信息，</font><font>请参见</font></font><a href="https://docs.gradle.org/nightly/userguide/organizing_gradle_projects.html#sec:build_sources" style="color:rgb(29, 162, 189);text-decoration:none;"><font><font>有关组织构建逻辑的部分</font></font></a><font><font>。</font></font></td></tr></tbody></table>

现在，在`buildSrc/src/main/java`目录中创建一个自定义任务类。您应该为此类命名`CreateMD5`。

buildSrc / src / main / java / CreateMD5.java

import org.apache.commons.codec.digest.DigestUtils; import org.apache.commons.io.FileUtils; import org.gradle.api.file.DirectoryProperty; import org.gradle.api.file.RegularFile; import org.gradle.api.provider.Provider; import org.gradle.api.tasks.OutputDirectory; import org.gradle.api.tasks.SourceTask; import org.gradle.api.tasks.TaskAction; import org.gradle.workers.WorkerExecutor; import java.io.File; import java.io.FileInputStream; import java.io.InputStream; abstract public class CreateMD5 extends SourceTask \{ \@OutputDirectory abstract public DirectoryProperty getDestinationDirectory\(\); \@TaskAction public void createHashes\(\) \{ for \(File sourceFile : getSource\(\).getFiles\(\)\) \{ try \{ InputStream stream = new FileInputStream\(sourceFile\); System.out.println\("Generating MD5 for " + sourceFile.getName\(\) + "..."\); // Artificially make this task slower. Thread.sleep\(3000\); Provider\<RegularFile> md5File = getDestinationDirectory\(\).file\(sourceFile.getName\(\) + ".md5"\); FileUtils.writeStringToFile\(md5File.get\(\).getAsFile\(\), DigestUtils.md5Hex\(stream\), \(String\) null\); \} catch \(Exception e\) \{ throw new RuntimeException\(e\); \} \} \} \}

 

1

import org.apache.commons.codec.digest.DigestUtils;

2

import org.apache.commons.io.FileUtils;

3

import org.gradle.api.file.DirectoryProperty;

4

import org.gradle.api.file.RegularFile;

5

import org.gradle.api.provider.Provider;

6

import org.gradle.api.tasks.OutputDirectory;

7

import org.gradle.api.tasks.SourceTask;

8

import org.gradle.api.tasks.TaskAction;

9

import org.gradle.workers.WorkerExecutor;

10

11

import java.io.File;

12

import java.io.FileInputStream;

13

import java.io.InputStream;

14

15

abstract public class CreateMD5 extends SourceTask \{ 

16

17

 \@OutputDirectory

18

 abstract public DirectoryProperty getDestinationDirectory\(\); 

19

20

 \@TaskAction

21

 public void createHashes\(\) \{

22

 for \(File sourceFile : getSource\(\).getFiles\(\)\) \{ 

23

 try \{

24

 InputStream stream \= new FileInputStream\(sourceFile\);

25

 System.out.println\("Generating MD5 for " + sourceFile.getName\(\) + "..."\);

26

 // Artificially make this task slower.

27

 Thread.sleep\(3000\); 

28

 Provider\<RegularFile\> md5File \= getDestinationDirectory\(\).file\(sourceFile.getName\(\) + ".md5"\); 

29

 FileUtils.writeStringToFile\(md5File.get\(\).getAsFile\(\), DigestUtils.md5Hex\(stream\), \(String\) null\);

30

 \} catch \(Exception e\) \{

31

 throw new RuntimeException\(e\);

32

 \}

33

 \}

34

 \}

35

\}

<table style="background:none;"><tbody><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="1" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><a href="https://docs.gradle.org/nightly/javadoc/org/gradle/api/tasks/SourceTask.html" style="color:rgb(29, 162, 189);text-decoration:none;font-family:Inconsolata, monospace;"><font><font>SourceTask</font></font></a><font><font>是一种便利类型，用于对一组源文件进行操作的任务。</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="2" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>任务的输出将进入已配置的目录。</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="3" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>该任务遍历定义为“源文件”的所有文件，并为每个文件创建MD5哈希。</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="4" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>插入人工睡眠以模拟对大型文件进行哈希处理（示例文件不会那么大）。</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="5" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>每个文件的MD5哈希将写入输出目录中，扩展名为“ md5”。</font></font></td></tr></tbody></table>

接下来，创建一个`build.gradle(.kts)`注册新`CreateMD5`任务的。

`Groovy``Kotlin`

build.gradle

plugins \{ id 'base' \} tasks.register\("md5", CreateMD5\) \{ destinationDirectory = project.layout.buildDirectory.dir\("md5"\) source\(project.layout.projectDirectory.file\('src'\)\) \}

 

1

plugins \{ id 'base' \} 

2

3

tasks.register\("md5", CreateMD5\) \{

4

 destinationDirectory \= project.layout.buildDirectory.dir\("md5"\) 

5

 source\(project.layout.projectDirectory.file\('src'\)\) 

6

\}

<table style="background:none;"><tbody><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="1" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>应用</font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">base</code><font><font>插件，以便您有一个</font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">clean</code><font><font>任务</font><font>可用</font><font>来删除输出。</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="2" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>MD5哈希文件将写入</font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">build/md5</code><font><font>。</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="3" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>此任务将为目录中的每个文件生成MD5哈希文件</font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">src</code><font><font>。</font></font></td></tr></tbody></table>

现在，您将需要一些源来生成MD5哈希值。在src目录中创建3个文件：

src / einstein.txt

Intellectual growth should commence at birth and cease only at death.

 

1

Intellectual growth should commence at birth and cease only at death.

src / feynman.txt

I was born not knowing and have had only a little time to change that here and there.

 

1

I was born not knowing and have had only a little time to change that here and there.

src / oppenheimer.txt

No man should escape our universities without knowing how little he knows.

 

1

No man should escape our universities without knowing how little he knows.

此时，您可以尝试一下任务：

\$ gradle md5

您应该看到类似于以下内容的输出：

\>任务：md5 正在为einstein.txt生成MD5 ... 正在为feynman.txt生成MD5 ... 正在为oppenheimer.txt生成MD5 ...
 在0秒内成功建立 1个可执行的任务：1个已执行

在`build/md5`目录中，您现在应该看到带有`md5`扩展名的相应文件，该扩展名包含`src`目录中文件的MD5哈希。请注意，该任务至少需要9秒钟才能运行，因为它一次将每个文件散列一次（即，每个文件大约3秒散列3个文件）。

## [](https://docs.gradle.org/nightly/userguide/worker_api.html#converting_to_the_worker_api)[转换为Worker API](https://docs.gradle.org/nightly/userguide/worker_api.html#converting_to_the_worker_api)

尽管此任务按顺序处理每个文件，但是每个文件的处理都独立于任何其他文件。如果这项工作并行完成，并且可以利用多个处理器，那就太好了。这是Worker API可以提供帮助的地方。

首先，您需要定义一个接口，该接口代表每个工作单元的参数并扩展`org.gradle.workers.WorkParameters`。为了生成MD5散列文件，工作单元将需要两个参数：要散列的文件和向其写入散列的文件。但是，无需创建具体的实现，因为Gradle将在运行时为我们生成一个实现。

buildSrc / src / main / java / MD5WorkParameters.java

import org.gradle.api.file.RegularFileProperty; import org.gradle.workers.WorkParameters; public interface MD5WorkParameters extends WorkParameters \{ RegularFileProperty getSourceFile\(\); RegularFileProperty getMD5File\(\); \}

 

1

import org.gradle.api.file.RegularFileProperty;

2

import org.gradle.workers.WorkParameters;

3

4

public interface MD5WorkParameters extends WorkParameters \{

5

 RegularFileProperty getSourceFile\(\); 

6

 RegularFileProperty getMD5File\(\);

7

\}

<table style="background:none;"><tbody><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="1" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>使用</font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">Property</code><font><font>对象表示源和MD5哈希文件。</font></font></td></tr></tbody></table>

其次，您需要将自定义任务的一部分重构为一个单独的类，该部分将为每个文件进行工作。此类是您的“工作单元”实现，它应该是Extended的抽象类`org.gradle.workers.WorkAction`。

buildSrc / src / main / java / GenerateMD5.java

import org.apache.commons.codec.digest.DigestUtils; import org.apache.commons.io.FileUtils; import org.gradle.workers.WorkAction; import java.io.File; import java.io.FileInputStream; import java.io.InputStream; public abstract class GenerateMD5 implements WorkAction\<MD5WorkParameters> \{ \@Override public void execute\(\) \{ try \{ File sourceFile = getParameters\(\).getSourceFile\(\).getAsFile\(\).get\(\); File md5File = getParameters\(\).getMD5File\(\).getAsFile\(\).get\(\); InputStream stream = new FileInputStream\(sourceFile\); System.out.println\("Generating MD5 for " + sourceFile.getName\(\) + "..."\); // Artificially make this task slower. Thread.sleep\(3000\); FileUtils.writeStringToFile\(md5File, DigestUtils.md5Hex\(stream\), \(String\) null\); \} catch \(Exception e\) \{ throw new RuntimeException\(e\); \} \} \}

 

1

import org.apache.commons.codec.digest.DigestUtils;

2

import org.apache.commons.io.FileUtils;

3

import org.gradle.workers.WorkAction;

4

5

import java.io.File;

6

import java.io.FileInputStream;

7

import java.io.InputStream;

8

9

public abstract class GenerateMD5 implements WorkAction\<MD5WorkParameters\> \{ 

10

 \@Override

11

 public void execute\(\) \{

12

 try \{

13

 File sourceFile \= getParameters\(\).getSourceFile\(\).getAsFile\(\).get\(\);

14

 File md5File \= getParameters\(\).getMD5File\(\).getAsFile\(\).get\(\);

15

 InputStream stream \= new FileInputStream\(sourceFile\);

16

 System.out.println\("Generating MD5 for " + sourceFile.getName\(\) + "..."\);

17

 // Artificially make this task slower.

18

 Thread.sleep\(3000\);

19

 FileUtils.writeStringToFile\(md5File, DigestUtils.md5Hex\(stream\), \(String\) null\);

20

 \} catch \(Exception e\) \{

21

 throw new RuntimeException\(e\);

22

 \}

23

 \}

24

\}

<table style="background:none;"><tbody><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="1" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>不要实现该</font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">getParameters()</code><font><font>方法-Gradle将在运行时注入此方法。</font></font></td></tr></tbody></table>

现在，您应该更改自定义任务类，以将工作提交给\{api-reference\} org / gradle / workers / WorkerExecutor.html \[WorkerExecutor\]，而不是自己完成工作。

buildSrc / src / main / java / CreateMD5.java

import org.gradle.api.Action; import org.gradle.api.file.RegularFile; import org.gradle.api.provider.Provider; import org.gradle.api.tasks.\*; import org.gradle.workers.\*; import org.gradle.api.file.DirectoryProperty; import javax.inject.Inject; import java.io.File; abstract public class CreateMD5 extends SourceTask \{ \@OutputDirectory abstract public DirectoryProperty getDestinationDirectory\(\); \@Inject abstract public WorkerExecutor getWorkerExecutor\(\); \@TaskAction public void createHashes\(\) \{ WorkQueue workQueue = getWorkerExecutor\(\).noIsolation\(\); for \(File sourceFile : getSource\(\).getFiles\(\)\) \{ Provider\<RegularFile> md5File = getDestinationDirectory\(\).file\(sourceFile.getName\(\) + ".md5"\); workQueue.submit\(GenerateMD5.class, parameters -> \{ parameters.getSourceFile\(\).set\(sourceFile\); parameters.getMD5File\(\).set\(md5File\); \}\); \} \} \}

 

1

import org.gradle.api.Action;

2

import org.gradle.api.file.RegularFile;

3

import org.gradle.api.provider.Provider;

4

import org.gradle.api.tasks.\*;

5

import org.gradle.workers.\*;

6

import org.gradle.api.file.DirectoryProperty;

7

8

import javax.inject.Inject;

9

import java.io.File;

10

11

abstract public class CreateMD5 extends SourceTask \{

12

13

 \@OutputDirectory

14

 abstract public DirectoryProperty getDestinationDirectory\(\);

15

16

 \@Inject

17

 abstract public WorkerExecutor getWorkerExecutor\(\); 

18

19

 \@TaskAction

20

 public void createHashes\(\) \{

21

 WorkQueue workQueue \= getWorkerExecutor\(\).noIsolation\(\); 

22

23

 for \(File sourceFile : getSource\(\).getFiles\(\)\) \{

24

 Provider\<RegularFile\> md5File \= getDestinationDirectory\(\).file\(sourceFile.getName\(\) + ".md5"\);

25

 workQueue.submit\(GenerateMD5.class, parameters \-> \{ 

26

 parameters.getSourceFile\(\).set\(sourceFile\);

27

 parameters.getMD5File\(\).set\(md5File\);

28

 \}\);

29

 \}

30

 \}

31

\}

<table style="background:none;"><tbody><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="1" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>您需要具有</font></font><a href="https://docs.gradle.org/nightly/javadoc/org/gradle/workers/WorkerExecutor.html" style="color:rgb(29, 162, 189);text-decoration:none;font-family:Inconsolata, monospace;"><font><font>WorkerExecutor</font></font></a><font><font>服务才能提交您的工作。</font><font>创建一个带注释的抽象getter方法</font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">javax.inject.Inject</code><font><font>，当任务创建时，Gradle将在运行时注入服务。</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="2" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>在提交工作之前，您需要获取</font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">WorkQueue</code><font><font>具有所需隔离模式</font><font>的</font><font>对象。</font><font>稍后我们将详细讨论隔离模式。</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="3" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>在提交工作单元时，在这种情况下，请指定工作单元实现</font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">GenerateMD5</code><font><font>并配置其参数。</font></font></td></tr></tbody></table>

此时，您应该可以再次尝试您的任务。

\$ gradle clean md5
 >任务：md5 正在为einstein.txt生成MD5 ... 正在为feynman.txt生成MD5 ... 正在为oppenheimer.txt生成MD5 ...
 在0秒内成功建立 1个可执行的任务：1个已执行

尽管工作单元是并行执行的，但MD5哈希文件的生成顺序可能不同，结果应与以前相同。但是，您应该注意的一件事是任务运行得更快。这是因为Worker API对每个文件并行而不是按顺序执行MD5计算。

## [](https://docs.gradle.org/nightly/userguide/worker_api.html#changing_the_isolation_mode)[更改隔离模式](https://docs.gradle.org/nightly/userguide/worker_api.html#changing_the_isolation_mode)

隔离模式控制Gradle将工作项彼此隔离以及与Gradle运行时的其余部分隔离的强烈程度。有三种方法，`WorkerExecutor`即控制这样的：`noIsolation()`，`classLoaderIsolation()`和`processIsolation()`。的`noIsolation()`模式是最低的隔离级别，它将阻止工作单元更改项目状态。这是最快的隔离模式，因为它需要最少的开销来设置要执行的工作项，因此您可能希望在简单的情况下使用此模式。但是，它将对所有工作单元使用单个共享的类加载器。这意味着每个工作单元都可能通过静态类状态相互影响。这也意味着每个工作单元都使用buildscript类路径上相同版本的库。如果希望用户能够将任务配置为与其他（但兼容）版本的[Apache Commons Codec](https://commons.apache.org/proper/commons-codec/)库一起运行，则需要使用其他隔离模式。

首先，您需要将依赖项更改`buildSrc/build.gradle`为`compileOnly`。这告诉Gradle在构建类时应使用此依赖项，但不应将其放在构建脚本的类路径中。

`Groovy``Kotlin`

buildSrc / build.gradle

repositories \{ jcenter\(\) \} dependencies \{ implementation 'commons-io:commons-io:2.5' compileOnly 'commons-codec:commons-codec:1.9' \}

 

1

repositories \{

2

 jcenter\(\)

3

\}

4

5

dependencies \{

6

 implementation 'commons-io:commons-io:2.5'

7

 compileOnly 'commons-codec:commons-codec:1.9'

8

\}

接下来，您将需要更改`CreateMD5`任务，以允许用户配置他们要使用的编解码器库的版本。它将在运行时解析适当的库版本，并配置工作程序以使用该版本。该`classLoaderIsolation()`方法告诉Gradle使用隔离的类加载器在线程中运行此工作。

buildSrc / src / main / java / CreateMD5.java

import org.gradle.api.Action; import org.gradle.api.file.ConfigurableFileCollection; import org.gradle.api.file.DirectoryProperty; import org.gradle.api.file.RegularFile; import org.gradle.api.provider.Provider; import org.gradle.api.tasks.\*; import org.gradle.process.JavaForkOptions; import org.gradle.workers.\*; import javax.inject.Inject; import java.io.File; import java.util.Set; abstract public class CreateMD5 extends SourceTask \{ \@InputFiles abstract public ConfigurableFileCollection getCodecClasspath\(\); \@OutputDirectory abstract public DirectoryProperty getDestinationDirectory\(\); \@Inject abstract public WorkerExecutor getWorkerExecutor\(\); \@TaskAction public void createHashes\(\) \{ WorkQueue workQueue = getWorkerExecutor\(\).classLoaderIsolation\(workerSpec -> \{ workerSpec.getClasspath\(\).from\(getCodecClasspath\(\)\); \}\); for \(File sourceFile : getSource\(\).getFiles\(\)\) \{ Provider\<RegularFile> md5File = getDestinationDirectory\(\).file\(sourceFile.getName\(\) + ".md5"\); workQueue.submit\(GenerateMD5.class, parameters -> \{ parameters.getSourceFile\(\).set\(sourceFile\); parameters.getMD5File\(\).set\(md5File\); \}\); \} \} \}

 

1

import org.gradle.api.Action;

2

import org.gradle.api.file.ConfigurableFileCollection;

3

import org.gradle.api.file.DirectoryProperty;

4

import org.gradle.api.file.RegularFile;

5

import org.gradle.api.provider.Provider;

6

import org.gradle.api.tasks.\*;

7

import org.gradle.process.JavaForkOptions;

8

import org.gradle.workers.\*;

9

10

import javax.inject.Inject;

11

import java.io.File;

12

import java.util.Set;

13

14

abstract public class CreateMD5 extends SourceTask \{

15

16

 \@InputFiles

17

 abstract public ConfigurableFileCollection getCodecClasspath\(\); 

18

19

 \@OutputDirectory

20

 abstract public DirectoryProperty getDestinationDirectory\(\);

21

22

 \@Inject

23

 abstract public WorkerExecutor getWorkerExecutor\(\);

24

25

 \@TaskAction

26

 public void createHashes\(\) \{

27

 WorkQueue workQueue \= getWorkerExecutor\(\).classLoaderIsolation\(workerSpec \-> \{

28

 workerSpec.getClasspath\(\).from\(getCodecClasspath\(\)\); 

29

 \}\);

30

31

 for \(File sourceFile : getSource\(\).getFiles\(\)\) \{

32

 Provider\<RegularFile\> md5File \= getDestinationDirectory\(\).file\(sourceFile.getName\(\) + ".md5"\);

33

 workQueue.submit\(GenerateMD5.class, parameters \-> \{

34

 parameters.getSourceFile\(\).set\(sourceFile\);

35

 parameters.getMD5File\(\).set\(md5File\);

36

 \}\);

37

 \}

38

 \}

39

\}

<table style="background:none;"><tbody><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="1" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>公开编解码器库类路径的输入属性。</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="2" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>创建工作队列时</font><font>，请在</font></font><a href="https://docs.gradle.org/nightly/javadoc/org/gradle/workers/ClassLoaderWorkerSpec.html" style="color:rgb(29, 162, 189);text-decoration:none;font-family:Inconsolata, monospace;"><font><font>ClassLoaderWorkerSpec</font></font></a><font><font>上配置类路径</font><font>。</font></font></td></tr></tbody></table>

接下来，您将需要配置构建，以便它具有一个存储库以在任务执行时查找编解码器版本。我们还将创建一个依赖项来从此存储库解析我们的编解码器库。

`Groovy``Kotlin`

build.gradle

plugins \{ id 'base' \} repositories \{ jcenter\(\) \} configurations.create\('codec'\) \{ attributes \{ attribute\(Usage.USAGE\_ATTRIBUTE, objects.named\(Usage, Usage.JAVA\_RUNTIME\)\) \} visible = false canBeConsumed = false canBeResolved = true \} dependencies \{ codec 'commons-codec:commons-codec:1.10' \} tasks.register\('md5', CreateMD5\) \{ codecClasspath.from\(configurations.codec\) destinationDirectory = project.layout.buildDirectory.dir\('md5'\) source\(project.layout.projectDirectory.file\('src'\)\) \}

 

1

plugins \{ id 'base' \}

2

3

repositories \{

4

 jcenter\(\) 

5

\}

6

7

configurations.create\('codec'\) \{ 

8

 attributes \{

9

 attribute\(Usage.USAGE\_ATTRIBUTE, objects.named\(Usage, Usage.JAVA\_RUNTIME\)\)

10

 \}

11

 visible \= false

12

 canBeConsumed \= false

13

 canBeResolved \= true

14

\}

15

16

dependencies \{

17

 codec 'commons-codec:commons-codec:1.10' 

18

\}

19

20

tasks.register\('md5', CreateMD5\) \{

21

 codecClasspath.from\(configurations.codec\) 

22

 destinationDirectory \= project.layout.buildDirectory.dir\('md5'\)

23

 source\(project.layout.projectDirectory.file\('src'\)\)

24

\}

<table style="background:none;"><tbody><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="1" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>添加一个存储库以解析编解码器库-该存储库可以与用于构建</font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">CreateMD5</code><font><font>任务类的</font><font>存储库不同</font><font>。</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="2" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>添加</font></font><em style="font-style:italic;"><font><font>配置</font></font></em><font><font>以解析我们的编解码器库版本。</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="3" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>配置</font></font><a href="https://commons.apache.org/proper/commons-codec/" style="color:rgb(29, 162, 189);text-decoration:none;"><font><font>Apache Commons Codec</font></font></a><font><font>的备用兼容版本</font><font>。</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="4" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>配置</font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">md5</code><font><font>任务以将配置用作其类路径。</font><font>请注意，在实际执行任务之前，不会解析该配置。</font></font></td></tr></tbody></table>

现在，如果您运行任务，则可以使用编解码器库的配置版本按预期工作：

\$ gradle clean md5
 >任务：md5 正在为einstein.txt生成MD5 ... 正在为feynman.txt生成MD5 ... 正在为oppenheimer.txt生成MD5 ...
 在0秒内成功建立 1个可执行的任务：1个已执行

## [](https://docs.gradle.org/nightly/userguide/worker_api.html#creating_a_worker_daemon)[创建一个工人守护进程](https://docs.gradle.org/nightly/userguide/worker_api.html#creating_a_worker_daemon)

有时，在执行工作项时需要进一步隔离。例如，外部库可能依赖于要设置的某些系统属性，这些属性可能在工作项之间发生冲突。或者库可能与Gradle所运行的JDK版本不兼容，并且可能需要与其他版本一起运行。Worker API可以使用`processIsolation()`导致工作在单独的“ worker守护程序”中执行的方法来容纳这一点。这些工作程序守护程序进程将在构建之间持久存在，并且可以在后续构建中重用。但是，如果系统资源不足，Gradle将停止所有未使用的工作程序守护程序。

要利用worker守护程序，只需`processIsolation()`在创建时使用方法`WorkQueue`。您可能还需要为新过程配置自定义设置。

buildSrc / src / main / java / CreateMD5.java

import org.gradle.api.Action; import org.gradle.api.file.ConfigurableFileCollection; import org.gradle.api.file.DirectoryProperty; import org.gradle.api.file.RegularFile; import org.gradle.api.provider.Provider; import org.gradle.api.tasks.\*; import org.gradle.process.JavaForkOptions; import org.gradle.workers.\*; import javax.inject.Inject; import java.io.File; import java.util.Set; abstract public class CreateMD5 extends SourceTask \{ \@InputFiles abstract public ConfigurableFileCollection getCodecClasspath\(\); \@OutputDirectory abstract public DirectoryProperty getDestinationDirectory\(\); \@Inject abstract public WorkerExecutor getWorkerExecutor\(\); \@TaskAction public void createHashes\(\) \{ WorkQueue workQueue = getWorkerExecutor\(\).processIsolation\(workerSpec -> \{ workerSpec.getClasspath\(\).from\(getCodecClasspath\(\)\); workerSpec.forkOptions\(options -> \{ options.setMaxHeapSize\("64m"\); \}\); \}\); for \(File sourceFile : getSource\(\).getFiles\(\)\) \{ Provider\<RegularFile> md5File = getDestinationDirectory\(\).file\(sourceFile.getName\(\) + ".md5"\); workQueue.submit\(GenerateMD5.class, parameters -> \{ parameters.getSourceFile\(\).set\(sourceFile\); parameters.getMD5File\(\).set\(md5File\); \}\); \} \} \}

 

1

import org.gradle.api.Action;

2

import org.gradle.api.file.ConfigurableFileCollection;

3

import org.gradle.api.file.DirectoryProperty;

4

import org.gradle.api.file.RegularFile;

5

import org.gradle.api.provider.Provider;

6

import org.gradle.api.tasks.\*;

7

import org.gradle.process.JavaForkOptions;

8

import org.gradle.workers.\*;

9

10

import javax.inject.Inject;

11

import java.io.File;

12

import java.util.Set;

13

14

abstract public class CreateMD5 extends SourceTask \{

15

16

 \@InputFiles

17

 abstract public ConfigurableFileCollection getCodecClasspath\(\); 

18

19

 \@OutputDirectory

20

 abstract public DirectoryProperty getDestinationDirectory\(\);

21

22

 \@Inject

23

 abstract public WorkerExecutor getWorkerExecutor\(\);

24

25

 \@TaskAction

26

 public void createHashes\(\) \{

27

  

28

 WorkQueue workQueue \= getWorkerExecutor\(\).processIsolation\(workerSpec \-> \{

29

 workerSpec.getClasspath\(\).from\(getCodecClasspath\(\)\);

30

 workerSpec.forkOptions\(options \-> \{

31

 options.setMaxHeapSize\("64m"\); 

32

 \}\);

33

 \}\);

34

35

 for \(File sourceFile : getSource\(\).getFiles\(\)\) \{

36

 Provider\<RegularFile\> md5File \= getDestinationDirectory\(\).file\(sourceFile.getName\(\) + ".md5"\);

37

 workQueue.submit\(GenerateMD5.class, parameters \-> \{

38

 parameters.getSourceFile\(\).set\(sourceFile\);

39

 parameters.getMD5File\(\).set\(md5File\);

40

 \}\);

41

 \}

42

 \}

43

\}

<table style="background:none;"><tbody><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="1" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>将隔离模式更改为</font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">PROCESS</code><font><font>。</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="2" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>为新过程设置{api-reference} org / gradle / process / JavaForkOptions.html [JavaForkOptions]。</font></font></td></tr></tbody></table>

现在，您应该能够运行您的任务，它将按预期运行，但可以使用辅助守护程序：

\$ gradle clean md5
 >任务：md5 正在为einstein.txt生成MD5 ... 正在为feynman.txt生成MD5 ... 正在为oppenheimer.txt生成MD5 ...
 在0秒内成功建立 1个可执行的任务：1个已执行

请注意，执行时间可能会有些长。这是因为Gradle必须为每个辅助守护程序启动一个新进程，这很昂贵。但是，如果再次运行任务，则会看到它运行得更快。这是因为在初始构建期间启动的辅助守护程序已经保留，并且可以在后续构建期间立即使用。

\$ gradle clean md5
 >任务：md5 正在为einstein.txt生成MD5 ... 正在为feynman.txt生成MD5 ... 正在为oppenheimer.txt生成MD5 ...
 在0秒内成功建立 1个可执行的任务：1个已执行  

来源： <https://docs.gradle.org/nightly/userguide/worker_api.html>