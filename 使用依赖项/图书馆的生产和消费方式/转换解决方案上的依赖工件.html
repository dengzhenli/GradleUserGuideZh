 无标题 <style id="wiz_custom_css">html, .wiz-editor-body {font-size: 12pt;}.wiz-editor-body {font-family: Helvetica, 'Hiragino Sans GB', '微软雅黑', 'Microsoft YaHei UI', SimSun, SimHei, arial, sans-serif;line-height: 1.7;margin: 0 auto;position:relative;padding: 20px 16px;}.wiz-editor-body h1,.wiz-editor-body h2,.wiz-editor-body h3,.wiz-editor-body h4,.wiz-editor-body h5,.wiz-editor-body h6 {margin:20px 0 10px;margin:1.25rem 0 0.625rem;padding: 0;font-weight: bold;}.wiz-editor-body h1 {font-size:20pt;font-size:1.67rem;}.wiz-editor-body h2 {font-size:18pt;font-size:1.5rem;}.wiz-editor-body h3 {font-size:15pt;font-size:1.25rem;}.wiz-editor-body h4 {font-size:14pt;font-size:1.17rem;}.wiz-editor-body h5 {font-size:12pt;font-size:1rem;}.wiz-editor-body h6 {font-size:12pt;font-size:1rem;color: #777777;margin: 1rem 0;}.wiz-editor-body div,.wiz-editor-body p,.wiz-editor-body ul,.wiz-editor-body ol,.wiz-editor-body dl,.wiz-editor-body li {margin:8px 0 0;}.wiz-editor-body blockquote,.wiz-editor-body table,.wiz-editor-body pre,.wiz-editor-body code {margin:8px 0;}.wiz-editor-body .CodeMirror pre {margin:0;}.wiz-editor-body a {word-wrap: break-word;text-decoration-skip-ink: none;}.wiz-editor-body ul,.wiz-editor-body ol {padding-left:32px;padding-left:2rem;}.wiz-editor-body ol.wiz-list-level1 > li {list-style-type:decimal;}.wiz-editor-body ol.wiz-list-level2 > li {list-style-type:lower-latin;}.wiz-editor-body ol.wiz-list-level3 > li {list-style-type:lower-roman;}.wiz-editor-body li.wiz-list-align-style {list-style-position: inside; margin-left: -1em;}.wiz-editor-body blockquote {padding: 0 12px;}.wiz-editor-body blockquote > :first-child {margin-top:0;}.wiz-editor-body blockquote > :last-child {margin-bottom:0;}.wiz-editor-body img {border:0;max-width:100%;height:auto !important;margin:2px 0;padding: 2px;vertical-align:bottom;}.wiz-editor-body table {border-collapse:collapse;border:1px solid #a7afbc;}.wiz-editor-body td,.wiz-editor-body th {padding:4px 8px;border-collapse:collapse;border:1px solid #a7afbc;min-height:28px;word-break:break-word;box-sizing: border-box;}.wiz-editor-body td > div:first-child {margin-top:0;}.wiz-editor-body td > div:last-child {margin-bottom:0;}.wiz-editor-body img.wiz-svg-image {box-shadow:1px 1px 4px #E8E8E8;}.wiz-editor-body .wiz-image-container {margin:0;max-width: 100%;display: inline-flex;flex-direction: column;}.wiz-editor-body .wiz-image-container .wiz-image-title {display:inline-block;text-align: center;color: #a7afbc;line-height: 18px;font-size: 12px;min-height: 18px;width: 100%;white-space: normal;}.wiz-hide {display:none !important;}.wiz-editor-body.wiz-editor-outline {padding-right:0; padding-left:0;}.wiz-editor-body.wiz-editor-outline .outline-container {margin:0; padding:0; line-height:1.5;}.wiz-editor-body.wiz-editor-outline .outline-container div {margin:0;}.wiz-editor-body.wiz-editor-outline .node {margin:0; padding: 0;}.wiz-editor-body.wiz-editor-outline .outline-container > .node {margin-right:24px; margin-left:30px;}.wiz-editor-body.wiz-editor-outline .node.collapsed .children {display:none;}.wiz-editor-body.wiz-editor-outline .node .row {position:relative; padding-left:26px;}.wiz-editor-body.wiz-editor-outline .node .operator-container {width:36px;position:absolute; top:4px; left:-18px;}.wiz-editor-body.wiz-editor-outline .node .operator-bar {position:absolute; top:0; left:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center;}.wiz-editor-body.wiz-editor-outline .node .switch {width:18px; height:18px;display:flex;flex-direction: column;align-items: center;overflow: hidden;}.wiz-editor-body.wiz-editor-outline .node .switch i {font-size:20px;position:relative;left:-1px;top:-1px;}.wiz-editor-body.wiz-editor-outline .node .switch.active {cursor:pointer;color:transparent; transition:transform 200ms ease 0s;}.wiz-editor-body.wiz-editor-outline .node.collapsed .switch.active {transform:rotateZ(-90deg);}.wiz-editor-body.wiz-editor-outline .node .row:hover .switch.active {color:#505F79}.wiz-editor-body.wiz-editor-outline .node .dot {display:flex; align-items:center; justify-content:center; border-radius:100%; width:18px; height:18px;}.wiz-editor-body.wiz-editor-outline .node.collapsed .dot {background-color:rgba(80, 95, 121, .15);}.wiz-editor-body.wiz-editor-outline .node .dot-icon {background-color:#505F79; border-radius:100%; width:6px; height:6px;}.wiz-editor-body.wiz-editor-outline .node .child {margin-left:8px; border-left:1px solid #E6E9ED; padding-left:17px;}.wiz-editor-body.wiz-editor-outline .node .content {flex:1;outline:none; padding:4px 0;}.wiz-editor-body.wiz-editor-outline .node div.content {font-size:1rem;}.wiz-editor-body.wiz-editor-outline .node.complete > .row .content {text-decoration:line-through;color:#A7AFBC;}.wiz-editor-body.wiz-editor-outline .node .notes {outline:none; font-size:.8rem; color:#A7AFBC;}.wiz-editor-body.wiz-editor-outline .node .image {outline:none; padding-top:4px; padding-bottom:4px;}.wiz-editor-body.wiz-editor-outline .outline-container h1,.wiz-editor-body.wiz-editor-outline .outline-container h2,.wiz-editor-body.wiz-editor-outline .outline-container h3,.wiz-editor-body.wiz-editor-outline .outline-container h4,.wiz-editor-body.wiz-editor-outline .outline-container h5,.wiz-editor-body.wiz-editor-outline .outline-container h6 {margin:0;}body, .wiz-editor-body { padding-left: 48px; padding-right: 48px;}</style><style id="wiz_code_style">.wiz-editor-body .wiz-code-container{position: relative; padding:8px 0; margin: 5px 0;text-indent:0; text-align:left;}.CodeMirror {font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace; color: black; font-size: 10.5pt; font-size: 0.875rem}.wiz-editor-body .wiz-code-container .CodeMirror div {margin-top: 0; margin-bottom: 0;}.CodeMirror-lines {padding: 4px 0;}.CodeMirror pre.CodeMirror-line,.CodeMirror pre.CodeMirror-line-like {padding: 0 4px;}.CodeMirror pre.CodeMirror-line {min-height: 24px;}.CodeMirror-scrollbar-filler, .CodeMirror-gutter-filler {background-color: white;}.CodeMirror-gutters {border-right: 1px solid #ddd; background-color: #f7f7f7; white-space: nowrap;}.CodeMirror-linenumbers {}.CodeMirror-linenumber {padding: 0 3px 0 5px; min-width: 20px; text-align: right; color: #999; white-space: nowrap;}.CodeMirror-guttermarker {color: black;}.CodeMirror-guttermarker-subtle {color: #999;}.CodeMirror-cursor {border-left: 1px solid black; border-right: none; width: 0;}.CodeMirror div.CodeMirror-secondarycursor {border-left: 1px solid silver;}.cm-fat-cursor .CodeMirror-cursor {width: auto; border: 0 !important; background: #7e7;}.cm-fat-cursor div.CodeMirror-cursors {z-index: 1;}.cm-fat-cursor-mark {background-color: rgba(20, 255, 20, 0.5);-webkit-animation: blink 1.06s steps(1) infinite;-moz-animation: blink 1.06s steps(1) infinite;animation: blink 1.06s steps(1) infinite;}.cm-animate-fat-cursor {width: auto; border: 0; -webkit-animation: blink 1.06s steps(1) infinite; -moz-animation: blink 1.06s steps(1) infinite; animation: blink 1.06s steps(1) infinite; background-color: #7e7;}@-moz-keyframes blink { 0% {} 50% { background-color: transparent; } 100% {}}@-webkit-keyframes blink { 0% {} 50% { background-color: transparent; } 100% {}}@keyframes blink { 0% {} 50% { background-color: transparent; } 100% {}}.CodeMirror-overwrite .CodeMirror-cursor {}.cm-tab { display: inline-block; text-decoration: inherit; }.CodeMirror-rulers {position: absolute; left: 0; right: 0; top: -50px; bottom: -20px; overflow: hidden;}.CodeMirror-ruler {border-left: 1px solid #ccc; top: 0; bottom: 0; position: absolute;}.cm-s-default .cm-header {color: blue;}.cm-s-default .cm-quote {color: #090;}.cm-negative {color: #d44;}.cm-positive {color: #292;}.cm-header, .cm-strong {font-weight: bold;}.cm-em {font-style: italic;}.cm-link {text-decoration: underline;}.cm-strikethrough {text-decoration: line-through;}.cm-s-default .cm-keyword {color: #708;}.cm-s-default .cm-atom {color: #219;}.cm-s-default .cm-number {color: #164;}.cm-s-default .cm-def {color: #00f;}.cm-s-default .cm-variable,.cm-s-default .cm-punctuation,.cm-s-default .cm-property,.cm-s-default .cm-operator {}.cm-s-default .cm-variable-2 {color: #05a;}.cm-s-default .cm-variable-3 {color: #085;}.cm-s-default .cm-comment {color: #a50;}.cm-s-default .cm-string {color: #a11;}.cm-s-default .cm-string-2 {color: #f50;}.cm-s-default .cm-meta {color: #555;}.cm-s-default .cm-qualifier {color: #555;}.cm-s-default .cm-builtin {color: #30a;}.cm-s-default .cm-bracket {color: #997;}.cm-s-default .cm-tag {color: #170;}.cm-s-default .cm-attribute {color: #00c;}.cm-s-default .cm-hr {color: #999;}.cm-s-default .cm-link {color: #00c;}.cm-s-default .cm-error {color: #f00;}.cm-invalidchar {color: #f00;}.CodeMirror-composing { border-bottom: 2px solid; }div.CodeMirror span.CodeMirror-matchingbracket {color: #0b0;}div.CodeMirror span.CodeMirror-nonmatchingbracket {color: #a22;}.CodeMirror-matchingtag { background: rgba(255, 150, 0, .3); }.CodeMirror-activeline-background {background: #e8f2ff;}.CodeMirror {position: relative; background: #f5f5f5;}.CodeMirror-scroll {overflow: hidden !important; margin-bottom: 0; margin-right: -30px; padding: 16px 30px 16px 0; outline: none; position: relative;}.CodeMirror-sizer {position: relative; border-right: 30px solid transparent;}.CodeMirror-vscrollbar, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-gutter-filler {position: absolute; z-index: 6; display: none;}.CodeMirror-vscrollbar {right: 0; top: 0; overflow-x: hidden; overflow-y: scroll;}.CodeMirror-hscrollbar {bottom: 0; left: 0 !important; overflow-y: hidden; overflow-x: scroll;pointer-events: auto !important;outline: none;}.CodeMirror-scrollbar-filler {right: 0; bottom: 0;}.CodeMirror-gutter-filler {left: 0; bottom: 0;}.CodeMirror-gutters {position: absolute; left: 0; top: 0; min-height: 100%; z-index: 3;}.CodeMirror-gutter {white-space: normal; height: 100%; display: inline-block; vertical-align: top; margin-bottom: -30px;}.CodeMirror-gutter-wrapper {position: absolute; z-index: 4; background: none !important; border: none !important;}.CodeMirror-gutter-background {position: absolute; top: 0; bottom: 0; z-index: 4;}.CodeMirror-gutter-elt {position: absolute; cursor: default; z-index: 4;}.CodeMirror-gutter-wrapper ::selection { background-color: transparent }.CodeMirror-gutter-wrapper ::-moz-selection { background-color: transparent }.CodeMirror-lines {cursor: text; min-height: 1px;}.CodeMirror pre.CodeMirror-line,.CodeMirror pre.CodeMirror-line-like {-moz-border-radius: 0; -webkit-border-radius: 0; border-radius: 0; border-width: 0; background: transparent; font-family: inherit; font-size: inherit; margin: 0; white-space: pre; word-wrap: normal; line-height: inherit; color: inherit; z-index: 2; position: relative; overflow: visible; -webkit-tap-highlight-color: transparent; -webkit-font-variant-ligatures: contextual; font-variant-ligatures: contextual;}.CodeMirror-wrap pre.CodeMirror-line,.CodeMirror-wrap pre.CodeMirror-line-like {word-wrap: break-word; white-space: pre-wrap; word-break: normal;}.CodeMirror-linebackground {position: absolute; left: 0; right: 0; top: 0; bottom: 0; z-index: 0;}.CodeMirror-linewidget {position: relative; z-index: 2; padding: 0.1px;}.CodeMirror-widget {}.CodeMirror-rtl pre { direction: rtl; }.CodeMirror-code {outline: none;}.CodeMirror-scroll,.CodeMirror-sizer,.CodeMirror-gutter,.CodeMirror-gutters,.CodeMirror-linenumber {-moz-box-sizing: content-box; box-sizing: content-box;}.CodeMirror-measure {position: absolute; width: 100%; height: 0; overflow: hidden; visibility: hidden;}.CodeMirror-cursor {position: absolute; pointer-events: none;}.CodeMirror-measure pre { position: static; }div.CodeMirror-cursors {visibility: hidden; position: relative; z-index: 3;}div.CodeMirror-dragcursors {visibility: visible;}.CodeMirror-focused div.CodeMirror-cursors {visibility: visible;}.CodeMirror-selected { background: #d9d9d9; }.CodeMirror-focused .CodeMirror-selected { background: #d7d4f0; }.CodeMirror-crosshair { cursor: crosshair; }.CodeMirror-line::selection, .CodeMirror-line > span::selection, .CodeMirror-line > span > span::selection { background: #d7d4f0; }.CodeMirror-line::-moz-selection, .CodeMirror-line > span::-moz-selection, .CodeMirror-line > span > span::-moz-selection { background: #d7d4f0; }.cm-searching {background: #ffa; background: rgba(255, 255, 0, .4);}.cm-force-border { padding-right: .1px; }@media print { .CodeMirror div.CodeMirror-cursors {visibility: hidden;}}.cm-tab-wrap-hack:after { content: ""; }span.CodeMirror-selectedtext { background: none; }.CodeMirror-activeline-background, .CodeMirror-selected {transition: visibility 0ms 100ms;}.CodeMirror-blur .CodeMirror-activeline-background, .CodeMirror-blur .CodeMirror-selected {visibility:hidden;}.CodeMirror-blur .CodeMirror-matchingbracket {color:inherit !important;outline:none !important;text-decoration:none !important;}.CodeMirror-sizer {min-height:auto !important;}</style>

# 转换解决方案上的依赖工件

内容

* [工件转换的选择和执行](#artifact_transform_selection_and_execution)
* [实现工件转换](#sec:implementing-artifact-transforms)
* [注册工件转换](#registering_artifact_transforms)
* [实现增量工件转换](#implementing_incremental_artifact_transforms)

如在[不同类型的配置中所述]()，对于相同的依赖项可能会有不同的变体。例如，外部Maven依赖项具有针对依赖项（`java-api`）进行编译时应使用的变体，以及用于运行使用依赖项（`java-runtime`）的应用程序的变体。项目依赖项甚至具有更多的变体，例如，用于编译的项目类可作为类目录（`org.gradle.usage=java-api, org.gradle.libraryelements=classes`）或JAR（`org.gradle.usage=java-api, org.gradle.libraryelements=jar`）获得。

依赖项的变体在其传递性依赖项或工件本身中可能有所不同。例如，Maven依赖项的`java-api`和`java-runtime`变体仅在传递性依赖项上有所不同，并且都使用相同的工件-JAR文件。对于项目依赖项，`java-api,classes`和`java-api,jars`变量具有相同的传递依赖项和不同的工件—分别是类目录和JAR文件。

Gradle通过其[属性]()集唯一地标识依赖项的变体。的`java-api`依赖关系的变体是由所识别的所述变体`org.gradle.usage`与值属性`java-api`。

当Gradle解析配置时，解析的配置上的[属性]()将确定_请求的属性_。对于配置中的所有依赖关系，在解析配置时都会选择具有请求属性的变量。例如，当配置请求`org.gradle.usage=java-api, org.gradle.libraryelements=classes`项目依赖项时，则将classes目录选择为工件。

如果依赖项没有具有所请求属性的变量，则解析配置失败。有时，可以在不更改传递依赖项的情况下将依赖项的工件转换为请求的变体。例如，解压缩JAR会将`java-api,jars`变体的工件转换为`java-api,classes`变体。这种转换称为“_伪影转换”_。Gradle允许注册工件转换，并且当依赖项没有所请求的变体时，Gradle将尝试查找一系列工件转换以创建变体。

## [](#artifact_transform_selection_and_execution)[工件转换的选择和执行](#artifact_transform_selection_and_execution)

如上所述，当Gradle解析配置并且配置中的依存关系不具有具有所请求属性的变体时，Gradle会尝试查找一系列工件转换以创建变体。找到伪影变换的匹配链的过程称为_伪影变换选择_。每个注册的转换都从一组属性转换为一组属性。例如，解压缩转换可以从转换`org.gradle.usage=java-api, org.gradle.libraryelements=jars`为`org.gradle.usage=java-api, org.gradle.libraryelements=classes`。

为了找到一条链，Gradle从请求的属性开始，然后将所有修改某些请求的属性的转换视为通向那里的可能路径。倒退，Gradle尝试使用转换获取到某些现有变体的路径。

例如，考虑一个`minified`具有两个值的属性：`true`和`false`。minified属性表示依赖项的变体，其中删除了不必要的类文件。注册了一个伪像转换，它可以`minified`从转换`false`为`true`。当`minified=true`要求提供依赖项时，并且只有带有的变体`minified=false`，然后Gradle选择注册的缩小变换。该缩小变换是能够与改造依赖的神器`minified=false`与神器`minified=true`。

在找到的所有变换链中，Gradle尝试选择最佳的变换链：

* 如果只有一个转换链，则选择它。
* 如果有两个变换链，并且一个是另一个的后缀，则将其选中。
* 如果存在最短的变换链，则将其选中。
* 在所有其他情况下，选择将失败并报告错误。

<table style="background:none;width:912px;"><tbody><tr><td class="icon" style="color:rgba(0, 0, 0, 0.8);width:80px;"><i class="fa icon-note"></i></td><td class="content" style="font-size:1.0625rem;color:rgba(0, 0, 0, 0.6);"><div class="paragraph"><p style="font-size: 1rem;"><font><font>当已经存在与请求属性匹配的依赖项变体时，Gradle不会尝试选择工件转换。</font></font></p></div></td></tr></tbody></table>

<table style="background:none;width:912px;"><tbody><tr><td class="icon" style="color:rgba(0, 0, 0, 0.8);width:80px;"><i class="fa icon-note"></i></td><td class="content" style="font-size:1.0625rem;color:rgba(0, 0, 0, 0.6);"><div class="paragraph"><p style="font-size: 1rem;"><font><font>该</font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">artifactType</code><font><font>属性是特殊的，因为它仅存在于已解析的工件上，而不存在于依赖项上。</font><font>结果，</font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">artifactType</code><font><font>当解析仅具有</font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">artifactType</code><font><font>按请求的属性</font><font>的配置时，永远不会选择</font><font>仅变异的任何变换</font><font>。</font><font>仅在使用</font></font><a href="" style="color:rgb(29, 162, 189);text-decoration:none;font-family:Inconsolata, monospace;"><font><font>ArtifactView</font></font></a><font><font>时才考虑使用</font><font>。</font></font></p></div></td></tr></tbody></table>

选择所需的工件变换后，Gradle会解析链中初始变换所需的依赖项变体。一旦Gradle完成了变体的工件解析，通过下载外部依赖项或执行生成工件的任务，Gradle便开始使用选定的工件转换链来转换变体的工件。Gradle在可能的情况下并行执行变换链。

拿起上面的minify示例，考虑具有两个依赖项的配置，外部`guava`依赖项和项目的项目依赖项`producer`。该配置具有属性`org.gradle.usage=java-runtime,org.gradle.libraryelements=jar,minified=true`。外部`guava`依赖项有两个变体：

* `org.gradle.usage=java-runtime,org.gradle.libraryelements=jar,minified=false`和
* `org.gradle.usage=java-api,org.gradle.libraryelements=jar,minified=false`。

使用缩小变换，摇篮可以转换的变型`org.gradle.usage=java-runtime,org.gradle.libraryelements=jar,minified=false`的`guava`到`org.gradle.usage=java-runtime,org.gradle.libraryelements=jar,minified=true`，这是请求的属性。项目依赖项还具有变体：

* `org.gradle.usage=java-runtime,org.gradle.libraryelements=jar,minified=false`，
* `org.gradle.usage=java-runtime,org.gradle.libraryelements=classes,minified=false`，
* `org.gradle.usage=java-api,org.gradle.libraryelements=jar,minified=false`，
* `org.gradle.usage=java-api,org.gradle.libraryelements=classes,minified=false`
* 还有一些。

同样，使用minify变换，Gradle可以将`org.gradle.usage=java-runtime,org.gradle.libraryelements=jar,minified=false`项目的变体转换`producer`为`org.gradle.usage=java-runtime,org.gradle.libraryelements=jar,minified=true`，这是请求的属性。

解决配置问题后，Gradle需要下载`guava`JAR并将其缩小。Gradle还需要执行`producer:jar`任务以生成项目的JAR工件，然后将其最小化。事件的下载和最小化与任务`guava.jar`的执行`producer:jar`以及结果JAR的最小化同时进行。

这是设置`minified`属性的方法，以便上面的方法起作用。您需要在模式中注册新属性，将其添加到所有JAR工件中，并在所有可解析配置上请求它。

例子1.工件转换属性设置

`Groovy``Kotlin`

build.gradle

def artifactType = Attribute.of\('artifactType', String\) def minified = Attribute.of\('minified', Boolean\) dependencies \{ attributesSchema \{ attribute\(minified\) \} artifactTypes.getByName\("jar"\) \{ attributes.attribute\(minified, false\) \} \} configurations.all \{ afterEvaluate \{ if \(canBeResolved\) \{ attributes.attribute\(minified, true\) \} \} \} dependencies \{ registerTransform\(Minify\) \{ from.attribute\(minified, false\).attribute\(artifactType, "jar"\) to.attribute\(minified, true\).attribute\(artifactType, "jar"\) \} \} dependencies \{ implementation\('com.google.guava:guava:27.1-jre'\) implementation\(project\(':producer'\)\) \}

 

1

def artifactType \= Attribute.of\('artifactType', String\)

2

def minified \= Attribute.of\('minified', Boolean\)

3

dependencies \{

4

 attributesSchema \{

5

 attribute\(minified\) 

6

 \}

7

 artifactTypes.getByName\("jar"\) \{

8

 attributes.attribute\(minified, false\) 

9

 \}

10

\}

11

12

configurations.all \{

13

 afterEvaluate \{

14

 if \(canBeResolved\) \{

15

 attributes.attribute\(minified, true\) 

16

 \}

17

 \}

18

\}

19

20

dependencies \{

21

 registerTransform\(Minify\) \{

22

 from.attribute\(minified, false\).attribute\(artifactType, "jar"\)

23

 to.attribute\(minified, true\).attribute\(artifactType, "jar"\)

24

 \}

25

\}

26

27

dependencies \{ 

28

 implementation\('com.google.guava:guava:27.1-jre'\)

29

 implementation\(project\(':producer'\)\)

30

\}

<table style="background:none;"><tbody><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="1" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>将属性添加到架构</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="2" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>所有JAR文件未压缩</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="3" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>请求</font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">minified=true</code><font><font>所有可解析的配置</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="4" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>添加将要转换的依赖项</font></font></td></tr></tbody></table>

现在，您可以看到当我们运行`resolveRuntimeClasspath`解析`runtimeClasspath`配置的任务时会发生什么。观察到Gradle在`resolveRuntimeClasspath`任务开始之前会转换项目依赖关系。Gradle执行`resolveRuntimeClasspath`任务时会转换二进制依赖关系。

解决runtimeClasspath配置时的输出

\> gradle resolveRuntimeClasspath
 >任务：producer：compileJava >任务：producer：processResources NO-SOURCE >任务：生产者：类 >任务：producer：jar
 >使用Minify转换producer.jar（project：producer） 没什么可缩小的-使用producer.jar不变
 >任务：resolveRuntimeClasspath 缩小番石榴27.1-jre.jar 没什么可减少的-使用listenablefuture-9999.0-empty-to-以避免冲突与guava.jar保持不变 没什么可缩小的-使用jsr305-3.0.2.jar不变 没什么好用的-使用checker-qual-2.5.2.jar不变 没什么可缩小的-使用error\_prone\_annotations-2.2.0.jar不变 没什么可缩小的-不变地使用j2objc-annotations-1.1.jar 没什么可减少的-使用animal-sniffer-annotations-1.17.jar不变 没什么可缩小的-使用failureaccess-1.0.1.jar不变
 在0秒内成功建立 3个可执行的任务：3个已执行

## [](#sec:implementing-artifact-transforms)[实现工件转换](#sec:implementing-artifact-transforms)

与任务类型相似，工件转换由一个动作和一些参数组成。与自定义任务类型的主要区别在于，操作和参数被实现为两个单独的类。

工件转换动作的实现是实现[TransformAction]()的类。您需要`transform()`在action上实现该方法，该方法将输入工件转换为零，一个或多个输出工件。大多数伪像转换将是一对一的，因此transform方法会将输入伪像转换为恰好一个输出伪像。

工件转换动作的实现需要通过调用[TransformOutputs.dir（）]()或[TransformOutputs.file（）]()来注册每个输出工件。

您只能提供`dir`或`file`方法的两种类型的路径：

* 输入工件或输入工件（对于输入目录）中的绝对路径。
* 相对路径。

Gradle使用绝对路径作为输出工件的位置。例如，如果输入工件是爆炸的WAR，则transform操作可以调用`TransformOutputs.file()`目录中的所有jar文件`WEB-INF/lib`。转换的输出将是Web应用程序的库JAR。

对于相对路径，`dir()`or`file()`方法将工作空间返回到transform操作。转换动作的实现需要在提供的工作空间的位置处创建转换后的工件。

输出工件按注册顺序替换了转换后的变体中的输入工件。例如，如果该配置包括伪影`lib1.jar`，`lib2.jar`，`lib3.jar`，和变换动作寄存器一个缩小的输出伪像`<artifact-name>-min.jar`的伪像输入，然后转化配置由伪影`lib1-min.jar`，`lib2-min.jar`和`lib3-min.jar`。

这是一个`Unzip`转换的实现，该转换通过解压缩JAR文件将其转换为类目录。该`Unzip`转换不需要任何参数。注意实现如何`@InputArtifact`用于注入工件以转换为动作。它使用来请求`TransformOutputs.dir()`解压缩类的目录，然后将JAR文件解压缩到该目录中。

例子2.没有参数的工件转换

`Groovy``Kotlin`

build.gradle

abstract class Unzip implements TransformAction\<TransformParameters.None> \{ \@InputArtifact abstract Provider\<FileSystemLocation> getInputArtifact\(\) \@Override void transform\(TransformOutputs outputs\) \{ def input = inputArtifact.get\(\).asFile def unzipDir = outputs.dir\(input.name\) unzipTo\(input, unzipDir\) \} private static void unzipTo\(File zipFile, File unzipDir\) \{ // implementation... \} \}

 

1

abstract class Unzip implements TransformAction\<TransformParameters.None\> \{ 

2

 \@InputArtifact 

3

 abstract Provider\<FileSystemLocation\> getInputArtifact\(\)

4

5

 \@Override

6

 void transform\(TransformOutputs outputs\) \{

7

 def input \= inputArtifact.get\(\).asFile

8

 def unzipDir \= outputs.dir\(input.name\) 

9

 unzipTo\(input, unzipDir\) 

10

 \}

11

12

 private static void unzipTo\(File zipFile, File unzipDir\) \{

13

 // implementation...

14

 \}

15

\}

<table style="background:none;"><tbody><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="1" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>使用</font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">TransformParameters.None</code><font><font>如果转换不使用参数</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="2" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>注入输入工件</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="3" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>请求解压缩文件的输出位置</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="4" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>做转换的实际工作</font></font></td></tr></tbody></table>

伪像转换可能需要参数，例如`String`确定一些过滤器或某些文件集合，这些参数用于支持输入伪像的转换。为了将这些参数传递给转换动作，您需要使用所需参数定义一个新类型。该类型需要实现标记接口[TransformParameters]()。必须使用[托管属性]()来表示参数，并且参数类型必须是[托管类型]()。您可以使用接口或抽象类声明getter，然后Gradle将生成实现。所有吸气剂都需要具有正确的输入注释，请参阅“[增量构建]()”部分中的表。

您可以在[开发自定义Gradle类型中]()找到有关实现工件转换参数的更多信息。

这是`Minify`通过仅保留某些类来使JAR变小的转换的实现。该`Minify`变换需要的类，以保持作为参数。观察如何通过获取参数`TransformAction.getParameters()`的`transform()`方法。该`transform()`方法的实现通过使用来请求缩小的JAR的位置`TransformOutputs.file()`，然后在该位置创建缩小的JAR。

例子3.缩小转换实现

`Groovy``Kotlin`

build.gradle

abstract class Minify implements TransformAction\<Parameters> \{ interface Parameters extends TransformParameters \{ \@Input Map\<String, Set\<String>> getKeepClassesByArtifact\(\) void setKeepClassesByArtifact\(Map\<String, Set\<String>> keepClasses\) \} \@PathSensitive\(PathSensitivity.NAME\_ONLY\) \@InputArtifact abstract Provider\<FileSystemLocation> getInputArtifact\(\) \@Override void transform\(TransformOutputs outputs\) \{ def fileName = inputArtifact.get\(\).asFile.name for \(entry in parameters.keepClassesByArtifact\) \{ if \(fileName.startsWith\(entry.key\)\) \{ def nameWithoutExtension = fileName.substring\(0, fileName.length\(\) - 4\) minify\(inputArtifact.get\(\).asFile, entry.value, outputs.file\("\$\{nameWithoutExtension\}-min.jar"\)\) return \} \} println "Nothing to minify - using \$\{fileName\} unchanged" outputs.file\(inputArtifact\) \} private void minify\(File artifact, Set\<String> keepClasses, File jarFile\) \{ println "Minifying \$\{artifact.name\}" // Implementation ... \} \}

 

1

abstract class Minify implements TransformAction\<Parameters\> \{ 

2

 interface Parameters extends TransformParameters \{ 

3

 \@Input

4

 Map\<String, Set\<String\>> getKeepClassesByArtifact\(\)

5

 void setKeepClassesByArtifact\(Map\<String, Set\<String\>> keepClasses\)

6

 \}

7

8

 \@PathSensitive\(PathSensitivity.NAME\_ONLY\)

9

 \@InputArtifact

10

 abstract Provider\<FileSystemLocation\> getInputArtifact\(\)

11

12

 \@Override

13

 void transform\(TransformOutputs outputs\) \{

14

 def fileName \= inputArtifact.get\(\).asFile.name

15

 for \(entry in parameters.keepClassesByArtifact\) \{ 

16

 if \(fileName.startsWith\(entry.key\)\) \{

17

 def nameWithoutExtension \= fileName.substring\(0, fileName.length\(\) \- 4\)

18

 minify\(inputArtifact.get\(\).asFile, entry.value, outputs.file\("\$\{nameWithoutExtension\}-min.jar"\)\)

19

 return

20

 \}

21

 \}

22

 println "Nothing to minify - using \$\{fileName\} unchanged"

23

 outputs.file\(inputArtifact\) 

24

 \}

25

26

 private void minify\(File artifact, Set\<String\> keepClasses, File jarFile\) \{

27

 println "Minifying \$\{artifact.name\}"

28

 // Implementation ...

29

 \}

30

\}

<table style="background:none;"><tbody><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="1" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>声明参数类型</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="2" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>转换参数的接口</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="3" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>使用参数</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="4" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>不需要缩小时使用不变的输入工件</font></font></td></tr></tbody></table>

请记住，输入工件是一个依赖项，它可能具有自己的依赖项。如果您的工件转换需要访问那些传递性依赖项，则可以声明一个抽象getter返回a`FileCollection`，并使用[\@InputArtifactDependencies]()对其进行[注释]()。运行转换时，Gradle将`FileCollection`通过实现getter将可传递依赖项注入该属性。请注意，在转换中使用输入工件依赖项会影响性能，只有在确实需要它们时才注入它们。

此外，工件转换可以将[构建缓存]()用于其输出。要为工件转换启用构建缓存，请在操作类上添加注释。对于可缓存的转换，必须使用规范化注释（例如[\@PathSensitive）]()注释其[\@InputArtifact]()属性（以及标有[\@InputArtifactDependencies的]()任何属性）。`@[CacheableTransform]()`

下面的示例显示一个更复杂的转换。它将JAR的某些选定类移动到不同的包，并使用移动的类重写类和所有类的字节码（类重定位）。为了确定要重定位的类，它查看输入工件的包和输入工件的依赖项。它还不会在外部类路径中重新放置JAR文件中包含的包。

例子4.用于类重定位的工件转换

`Groovy``Kotlin`

build.gradle

\@CacheableTransform abstract class ClassRelocator implements TransformAction\<Parameters> \{ interface Parameters extends TransformParameters \{ \@CompileClasspath ConfigurableFileCollection getExternalClasspath\(\) \@Input Property\<String> getExcludedPackage\(\) \} \@Classpath \@InputArtifact abstract Provider\<FileSystemLocation> getPrimaryInput\(\) \@CompileClasspath \@InputArtifactDependencies abstract FileCollection getDependencies\(\) \@Override void transform\(TransformOutputs outputs\) \{ def primaryInputFile = primaryInput.get\(\).asFile if \(parameters.externalClasspath.contains\(primaryInput\)\) \{ outputs.file\(primaryInput\) \} else \{ def baseName = primaryInputFile.name.substring\(0, primaryInputFile.name.length - 4\) relocateJar\(outputs.file\("\$baseName-relocated.jar"\)\) \} \} private relocateJar\(File output\) \{ // implementation... def relocatedPackages = \(dependencies.collectMany \{ readPackages\(it\) \} + readPackages\(primaryInput.get\(\).asFile\)\) as Set def nonRelocatedPackages = parameters.externalClasspath.collectMany \{ readPackages\(it\) \} def relocations = \(relocatedPackages - nonRelocatedPackages\).collect \{ packageName -> def toPackage = "relocated.\$packageName" println\("\$packageName -> \$toPackage"\) new Relocation\(packageName, toPackage\) \} new JarRelocator\(primaryInput.get\(\).asFile, output, relocations\).run\(\) \} \}

 

1

\@CacheableTransform 

2

abstract class ClassRelocator implements TransformAction\<Parameters\> \{

3

 interface Parameters extends TransformParameters \{ 

4

 \@CompileClasspath 

5

 ConfigurableFileCollection getExternalClasspath\(\)

6

 \@Input

7

 Property\<String\> getExcludedPackage\(\)

8

 \}

9

10

 \@Classpath 

11

 \@InputArtifact

12

 abstract Provider\<FileSystemLocation\> getPrimaryInput\(\)

13

14

 \@CompileClasspath

15

 \@InputArtifactDependencies 

16

 abstract FileCollection getDependencies\(\)

17

18

 \@Override

19

 void transform\(TransformOutputs outputs\) \{

20

 def primaryInputFile \= primaryInput.get\(\).asFile

21

 if \(parameters.externalClasspath.contains\(primaryInput\)\) \{ 

22

 outputs.file\(primaryInput\)

23

 \} else \{

24

 def baseName \= primaryInputFile.name.substring\(0, primaryInputFile.name.length \- 4\)

25

 relocateJar\(outputs.file\("\$baseName-relocated.jar"\)\)

26

 \}

27

 \}

28

29

 private relocateJar\(File output\) \{

30

 // implementation...

31

 def relocatedPackages \= \(dependencies.collectMany \{ readPackages\(it\) \} + readPackages\(primaryInput.get\(\).asFile\)\) as Set

32

 def nonRelocatedPackages \= parameters.externalClasspath.collectMany \{ readPackages\(it\) \}

33

 def relocations \= \(relocatedPackages \- nonRelocatedPackages\).collect \{ packageName \->

34

 def toPackage \= "relocated.\$packageName"

35

 println\("\$packageName -> \$toPackage"\)

36

 new Relocation\(packageName, toPackage\)

37

 \}

38

 new JarRelocator\(primaryInput.get\(\).asFile, output, relocations\).run\(\)

39

 \}

40

\}

<table style="background:none;"><tbody><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="1" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>声明可缓存的转换</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="2" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>转换参数的接口</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="3" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>声明每个参数的输入类型</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="4" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>声明输入工件的规范化</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="5" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>注入输入工件依赖项</font></font></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="6" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>使用参数</font></font></td></tr></tbody></table>

## [](#registering_artifact_transforms)[注册工件转换](#registering_artifact_transforms)

您需要注册工件转换动作，并在必要时提供参数，以便在解析依赖项时可以选择它们。

为了注册工件转换，必须在块内使用[registerTransform（）]()`dependencies {}`。

使用时需要注意以下几点`registerTransform()`：

* 将`from`和`to`属性是必需的。
* 转换动作本身可以具有配置选项。您可以使用`parameters {}`块组态它们。
* 您必须在具有将要解决的配置的项目上注册转换。
* 您可以提供任何实现[TransformAction的]()类型给该`registerTransform()`方法。

例如，假设您想解压缩一些依赖项并将解压缩的目录和文件放在类路径中。您可以通过注册type的工件转换操作来做到这一点`Unzip`，如下所示：

例子5.没有参数的工件变换配准

`Groovy``Kotlin`

build.gradle

def artifactType = Attribute.of\('artifactType', String\) dependencies \{ registerTransform\(Unzip\) \{ from.attribute\(artifactType, 'jar'\) to.attribute\(artifactType, 'java-classes-directory'\) \} \}

 

1

def artifactType \= Attribute.of\('artifactType', String\)

2

3

dependencies \{

4

 registerTransform\(Unzip\) \{

5

 from.attribute\(artifactType, 'jar'\)

6

 to.attribute\(artifactType, 'java-classes-directory'\)

7

 \}

8

\}

另一个示例是您想通过仅保留其中的一些`class`文件来缩小JAR。注意使用该`parameters {}`块来提供类，以将最小的JAR保存在`Minify`转换中。

例子6.带参数的工件转换配准

`Groovy``Kotlin`

build.gradle

def artifactType = Attribute.of\('artifactType', String\) def minified = Attribute.of\('minified', Boolean\) def keepPatterns = \[ "guava": \[ "com.google.common.base.Optional", "com.google.common.base.AbstractIterator" \] as Set \] dependencies \{ registerTransform\(Minify\) \{ from.attribute\(minified, false\).attribute\(artifactType, "jar"\) to.attribute\(minified, true\).attribute\(artifactType, "jar"\) parameters \{ keepClassesByArtifact = keepPatterns \} \} \}

 

1

def artifactType \= Attribute.of\('artifactType', String\)

2

def minified \= Attribute.of\('minified', Boolean\)

3

def keepPatterns \= \[

4

 "guava": \[

5

 "com.google.common.base.Optional",

6

 "com.google.common.base.AbstractIterator"

7

 \] as Set

8

\]

9

10

11

dependencies \{

12

 registerTransform\(Minify\) \{

13

 from.attribute\(minified, false\).attribute\(artifactType, "jar"\)

14

 to.attribute\(minified, true\).attribute\(artifactType, "jar"\)

15

16

 parameters \{

17

 keepClassesByArtifact \= keepPatterns

18

 \}

19

 \}

20

\}

## [](#implementing_incremental_artifact_transforms)[实现增量工件转换](#implementing_incremental_artifact_transforms)

与[增量任务]()类似，工件转换可以通过仅处理上次执行后已更改的文件来避免工作。这是通过使用[InputChanges]()接口完成的。对于工件转换，只有输入工件是增量输入，因此转换只能查询那里的更改。为了在转换动作中使用[InputChanges]()，请将其注入到动作中。有关如何使用[InputChanges的]()更多信息，请参见有关[增量任务]()的相应文档。

这是一个增量转换的示例，它计算Java源文件中的代码行：

例子7.代码计数行的工件转换

`Groovy``Kotlin`

build.gradle

abstract class CountLoc implements TransformAction\<TransformParameters.None> \{ \@Inject abstract InputChanges getInputChanges\(\) \@PathSensitive\(PathSensitivity.RELATIVE\) \@InputArtifact abstract Provider\<FileSystemLocation> getInput\(\) \@Override void transform\(TransformOutputs outputs\) \{ def outputDir = outputs.dir\("\$\{input.get\(\).asFile.name\}.loc"\) println\("Running transform on \$\{input.get\(\).asFile.name\}, incremental: \$\{inputChanges.incremental\}"\) inputChanges.getFileChanges\(input\).forEach \{ change -> def changedFile = change.file if \(change.fileType \!= FileType.FILE\) \{ return \} def outputLocation = new File\(outputDir, "\$\{change.normalizedPath\}.loc"\) switch \(change.changeType\) \{ case ADDED: case MODIFIED: println\("Processing file \$\{changedFile.name\}"\) outputLocation.parentFile.mkdirs\(\) outputLocation.text = changedFile.readLines\(\).size\(\) case REMOVED: println\("Removing leftover output file \$\{outputLocation.name\}"\) outputLocation.delete\(\) \} \} \} \}

 

1

abstract class CountLoc implements TransformAction\<TransformParameters.None\> \{

2

3

 \@Inject 

4

 abstract InputChanges getInputChanges\(\)

5

6

 \@PathSensitive\(PathSensitivity.RELATIVE\)

7

 \@InputArtifact

8

 abstract Provider\<FileSystemLocation\> getInput\(\)

9

10

 \@Override

11

 void transform\(TransformOutputs outputs\) \{

12

 def outputDir \= outputs.dir\("\$\{input.get\(\).asFile.name\}.loc"\)

13

 println\("Running transform on \$\{input.get\(\).asFile.name\}, incremental: \$\{inputChanges.incremental\}"\)

14

 inputChanges.getFileChanges\(input\).forEach \{ change \-> 

15

 def changedFile \= change.file

16

 if \(change.fileType \!= FileType.FILE\) \{

17

 return

18

 \}

19

 def outputLocation \= new File\(outputDir, "\$\{change.normalizedPath\}.loc"\)

20

 switch \(change.changeType\) \{

21

 case ADDED:

22

 case MODIFIED:

23

 println\("Processing file \$\{changedFile.name\}"\)

24

 outputLocation.parentFile.mkdirs\(\)

25

26

 outputLocation.text \= changedFile.readLines\(\).size\(\)

27

28

 case REMOVED:

29

 println\("Removing leftover output file \$\{outputLocation.name\}"\)

30

 outputLocation.delete\(\)

31

32

 \}

33

 \}

34

 \}

35

\}

<table style="background:none;"><tbody><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="1" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>注入<span>&nbsp;</span></font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">InputChanges</code></td></tr><tr style="background:none;"><td style="color:rgba(0, 0, 0, 0.8);"><i class="conum" data-value="2" style="background-color: rgba(0, 0, 0, 0.8); font-size: 0.75rem; font-family: Lato, Arial, sans-serif; color: rgb(255, 255, 255) !important;"></i></td><td style="color:rgba(0, 0, 0, 0.8);"><font><font>查询输入工件中的更改</font></font></td></tr></tbody></table>