 无标题 <style id="wiz_custom_css">html, .wiz-editor-body {font-size: 12pt;}.wiz-editor-body {font-family: Helvetica, 'Hiragino Sans GB', '微软雅黑', 'Microsoft YaHei UI', SimSun, SimHei, arial, sans-serif;line-height: 1.7;margin: 0 auto;position:relative;padding: 20px 16px;}.wiz-editor-body h1,.wiz-editor-body h2,.wiz-editor-body h3,.wiz-editor-body h4,.wiz-editor-body h5,.wiz-editor-body h6 {margin:20px 0 10px;margin:1.25rem 0 0.625rem;padding: 0;font-weight: bold;}.wiz-editor-body h1 {font-size:20pt;font-size:1.67rem;}.wiz-editor-body h2 {font-size:18pt;font-size:1.5rem;}.wiz-editor-body h3 {font-size:15pt;font-size:1.25rem;}.wiz-editor-body h4 {font-size:14pt;font-size:1.17rem;}.wiz-editor-body h5 {font-size:12pt;font-size:1rem;}.wiz-editor-body h6 {font-size:12pt;font-size:1rem;color: #777777;margin: 1rem 0;}.wiz-editor-body div,.wiz-editor-body p,.wiz-editor-body ul,.wiz-editor-body ol,.wiz-editor-body dl,.wiz-editor-body li {margin:8px 0 0;}.wiz-editor-body blockquote,.wiz-editor-body table,.wiz-editor-body pre,.wiz-editor-body code {margin:8px 0;}.wiz-editor-body .CodeMirror pre {margin:0;}.wiz-editor-body a {word-wrap: break-word;text-decoration-skip-ink: none;}.wiz-editor-body ul,.wiz-editor-body ol {padding-left:32px;padding-left:2rem;}.wiz-editor-body ol.wiz-list-level1 > li {list-style-type:decimal;}.wiz-editor-body ol.wiz-list-level2 > li {list-style-type:lower-latin;}.wiz-editor-body ol.wiz-list-level3 > li {list-style-type:lower-roman;}.wiz-editor-body li.wiz-list-align-style {list-style-position: inside; margin-left: -1em;}.wiz-editor-body blockquote {padding: 0 12px;}.wiz-editor-body blockquote > :first-child {margin-top:0;}.wiz-editor-body blockquote > :last-child {margin-bottom:0;}.wiz-editor-body img {border:0;max-width:100%;height:auto !important;margin:2px 0;padding: 2px;vertical-align:bottom;}.wiz-editor-body table {border-collapse:collapse;border:1px solid #a7afbc;}.wiz-editor-body td,.wiz-editor-body th {padding:4px 8px;border-collapse:collapse;border:1px solid #a7afbc;min-height:28px;word-break:break-word;box-sizing: border-box;}.wiz-editor-body td > div:first-child {margin-top:0;}.wiz-editor-body td > div:last-child {margin-bottom:0;}.wiz-editor-body img.wiz-svg-image {box-shadow:1px 1px 4px #E8E8E8;}.wiz-editor-body .wiz-image-container {margin:0;max-width: 100%;display: inline-flex;flex-direction: column;}.wiz-editor-body .wiz-image-container .wiz-image-title {display:inline-block;text-align: center;color: #a7afbc;line-height: 18px;font-size: 12px;min-height: 18px;width: 100%;white-space: normal;}.wiz-hide {display:none !important;}.wiz-editor-body.wiz-editor-outline {padding-right:0; padding-left:0;}.wiz-editor-body.wiz-editor-outline .outline-container {margin:0; padding:0; line-height:1.5;}.wiz-editor-body.wiz-editor-outline .outline-container div {margin:0;}.wiz-editor-body.wiz-editor-outline .node {margin:0; padding: 0;}.wiz-editor-body.wiz-editor-outline .outline-container > .node {margin-right:24px; margin-left:30px;}.wiz-editor-body.wiz-editor-outline .node.collapsed .children {display:none;}.wiz-editor-body.wiz-editor-outline .node .row {position:relative; padding-left:26px;}.wiz-editor-body.wiz-editor-outline .node .operator-container {width:36px;position:absolute; top:4px; left:-18px;}.wiz-editor-body.wiz-editor-outline .node .operator-bar {position:absolute; top:0; left:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center;}.wiz-editor-body.wiz-editor-outline .node .switch {width:18px; height:18px;display:flex;flex-direction: column;align-items: center;overflow: hidden;}.wiz-editor-body.wiz-editor-outline .node .switch i {font-size:20px;position:relative;left:-1px;top:-1px;}.wiz-editor-body.wiz-editor-outline .node .switch.active {cursor:pointer;color:transparent; transition:transform 200ms ease 0s;}.wiz-editor-body.wiz-editor-outline .node.collapsed .switch.active {transform:rotateZ(-90deg);}.wiz-editor-body.wiz-editor-outline .node .row:hover .switch.active {color:#505F79}.wiz-editor-body.wiz-editor-outline .node .dot {display:flex; align-items:center; justify-content:center; border-radius:100%; width:18px; height:18px;}.wiz-editor-body.wiz-editor-outline .node.collapsed .dot {background-color:rgba(80, 95, 121, .15);}.wiz-editor-body.wiz-editor-outline .node .dot-icon {background-color:#505F79; border-radius:100%; width:6px; height:6px;}.wiz-editor-body.wiz-editor-outline .node .child {margin-left:8px; border-left:1px solid #E6E9ED; padding-left:17px;}.wiz-editor-body.wiz-editor-outline .node .content {flex:1;outline:none; padding:4px 0;}.wiz-editor-body.wiz-editor-outline .node div.content {font-size:1rem;}.wiz-editor-body.wiz-editor-outline .node.complete > .row .content {text-decoration:line-through;color:#A7AFBC;}.wiz-editor-body.wiz-editor-outline .node .notes {outline:none; font-size:.8rem; color:#A7AFBC;}.wiz-editor-body.wiz-editor-outline .node .image {outline:none; padding-top:4px; padding-bottom:4px;}.wiz-editor-body.wiz-editor-outline .outline-container h1,.wiz-editor-body.wiz-editor-outline .outline-container h2,.wiz-editor-body.wiz-editor-outline .outline-container h3,.wiz-editor-body.wiz-editor-outline .outline-container h4,.wiz-editor-body.wiz-editor-outline .outline-container h5,.wiz-editor-body.wiz-editor-outline .outline-container h6 {margin:0;}body, .wiz-editor-body { padding-left: 48px; padding-right: 48px;}</style><style id="wiz_code_style">.wiz-editor-body .wiz-code-container{position: relative; padding:8px 0; margin: 5px 0;text-indent:0; text-align:left;}.CodeMirror {font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace; color: black; font-size: 10.5pt; font-size: 0.875rem}.wiz-editor-body .wiz-code-container .CodeMirror div {margin-top: 0; margin-bottom: 0;}.CodeMirror-lines {padding: 4px 0;}.CodeMirror pre.CodeMirror-line,.CodeMirror pre.CodeMirror-line-like {padding: 0 4px;}.CodeMirror pre.CodeMirror-line {min-height: 24px;}.CodeMirror-scrollbar-filler, .CodeMirror-gutter-filler {background-color: white;}.CodeMirror-gutters {border-right: 1px solid #ddd; background-color: #f7f7f7; white-space: nowrap;}.CodeMirror-linenumbers {}.CodeMirror-linenumber {padding: 0 3px 0 5px; min-width: 20px; text-align: right; color: #999; white-space: nowrap;}.CodeMirror-guttermarker {color: black;}.CodeMirror-guttermarker-subtle {color: #999;}.CodeMirror-cursor {border-left: 1px solid black; border-right: none; width: 0;}.CodeMirror div.CodeMirror-secondarycursor {border-left: 1px solid silver;}.cm-fat-cursor .CodeMirror-cursor {width: auto; border: 0 !important; background: #7e7;}.cm-fat-cursor div.CodeMirror-cursors {z-index: 1;}.cm-fat-cursor-mark {background-color: rgba(20, 255, 20, 0.5);-webkit-animation: blink 1.06s steps(1) infinite;-moz-animation: blink 1.06s steps(1) infinite;animation: blink 1.06s steps(1) infinite;}.cm-animate-fat-cursor {width: auto; border: 0; -webkit-animation: blink 1.06s steps(1) infinite; -moz-animation: blink 1.06s steps(1) infinite; animation: blink 1.06s steps(1) infinite; background-color: #7e7;}@-moz-keyframes blink { 0% {} 50% { background-color: transparent; } 100% {}}@-webkit-keyframes blink { 0% {} 50% { background-color: transparent; } 100% {}}@keyframes blink { 0% {} 50% { background-color: transparent; } 100% {}}.CodeMirror-overwrite .CodeMirror-cursor {}.cm-tab { display: inline-block; text-decoration: inherit; }.CodeMirror-rulers {position: absolute; left: 0; right: 0; top: -50px; bottom: -20px; overflow: hidden;}.CodeMirror-ruler {border-left: 1px solid #ccc; top: 0; bottom: 0; position: absolute;}.cm-s-default .cm-header {color: blue;}.cm-s-default .cm-quote {color: #090;}.cm-negative {color: #d44;}.cm-positive {color: #292;}.cm-header, .cm-strong {font-weight: bold;}.cm-em {font-style: italic;}.cm-link {text-decoration: underline;}.cm-strikethrough {text-decoration: line-through;}.cm-s-default .cm-keyword {color: #708;}.cm-s-default .cm-atom {color: #219;}.cm-s-default .cm-number {color: #164;}.cm-s-default .cm-def {color: #00f;}.cm-s-default .cm-variable,.cm-s-default .cm-punctuation,.cm-s-default .cm-property,.cm-s-default .cm-operator {}.cm-s-default .cm-variable-2 {color: #05a;}.cm-s-default .cm-variable-3 {color: #085;}.cm-s-default .cm-comment {color: #a50;}.cm-s-default .cm-string {color: #a11;}.cm-s-default .cm-string-2 {color: #f50;}.cm-s-default .cm-meta {color: #555;}.cm-s-default .cm-qualifier {color: #555;}.cm-s-default .cm-builtin {color: #30a;}.cm-s-default .cm-bracket {color: #997;}.cm-s-default .cm-tag {color: #170;}.cm-s-default .cm-attribute {color: #00c;}.cm-s-default .cm-hr {color: #999;}.cm-s-default .cm-link {color: #00c;}.cm-s-default .cm-error {color: #f00;}.cm-invalidchar {color: #f00;}.CodeMirror-composing { border-bottom: 2px solid; }div.CodeMirror span.CodeMirror-matchingbracket {color: #0b0;}div.CodeMirror span.CodeMirror-nonmatchingbracket {color: #a22;}.CodeMirror-matchingtag { background: rgba(255, 150, 0, .3); }.CodeMirror-activeline-background {background: #e8f2ff;}.CodeMirror {position: relative; background: #f5f5f5;}.CodeMirror-scroll {overflow: hidden !important; margin-bottom: 0; margin-right: -30px; padding: 16px 30px 16px 0; outline: none; position: relative;}.CodeMirror-sizer {position: relative; border-right: 30px solid transparent;}.CodeMirror-vscrollbar, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-gutter-filler {position: absolute; z-index: 6; display: none;}.CodeMirror-vscrollbar {right: 0; top: 0; overflow-x: hidden; overflow-y: scroll;}.CodeMirror-hscrollbar {bottom: 0; left: 0 !important; overflow-y: hidden; overflow-x: scroll;pointer-events: auto !important;outline: none;}.CodeMirror-scrollbar-filler {right: 0; bottom: 0;}.CodeMirror-gutter-filler {left: 0; bottom: 0;}.CodeMirror-gutters {position: absolute; left: 0; top: 0; min-height: 100%; z-index: 3;}.CodeMirror-gutter {white-space: normal; height: 100%; display: inline-block; vertical-align: top; margin-bottom: -30px;}.CodeMirror-gutter-wrapper {position: absolute; z-index: 4; background: none !important; border: none !important;}.CodeMirror-gutter-background {position: absolute; top: 0; bottom: 0; z-index: 4;}.CodeMirror-gutter-elt {position: absolute; cursor: default; z-index: 4;}.CodeMirror-gutter-wrapper ::selection { background-color: transparent }.CodeMirror-gutter-wrapper ::-moz-selection { background-color: transparent }.CodeMirror-lines {cursor: text; min-height: 1px;}.CodeMirror pre.CodeMirror-line,.CodeMirror pre.CodeMirror-line-like {-moz-border-radius: 0; -webkit-border-radius: 0; border-radius: 0; border-width: 0; background: transparent; font-family: inherit; font-size: inherit; margin: 0; white-space: pre; word-wrap: normal; line-height: inherit; color: inherit; z-index: 2; position: relative; overflow: visible; -webkit-tap-highlight-color: transparent; -webkit-font-variant-ligatures: contextual; font-variant-ligatures: contextual;}.CodeMirror-wrap pre.CodeMirror-line,.CodeMirror-wrap pre.CodeMirror-line-like {word-wrap: break-word; white-space: pre-wrap; word-break: normal;}.CodeMirror-linebackground {position: absolute; left: 0; right: 0; top: 0; bottom: 0; z-index: 0;}.CodeMirror-linewidget {position: relative; z-index: 2; padding: 0.1px;}.CodeMirror-widget {}.CodeMirror-rtl pre { direction: rtl; }.CodeMirror-code {outline: none;}.CodeMirror-scroll,.CodeMirror-sizer,.CodeMirror-gutter,.CodeMirror-gutters,.CodeMirror-linenumber {-moz-box-sizing: content-box; box-sizing: content-box;}.CodeMirror-measure {position: absolute; width: 100%; height: 0; overflow: hidden; visibility: hidden;}.CodeMirror-cursor {position: absolute; pointer-events: none;}.CodeMirror-measure pre { position: static; }div.CodeMirror-cursors {visibility: hidden; position: relative; z-index: 3;}div.CodeMirror-dragcursors {visibility: visible;}.CodeMirror-focused div.CodeMirror-cursors {visibility: visible;}.CodeMirror-selected { background: #d9d9d9; }.CodeMirror-focused .CodeMirror-selected { background: #d7d4f0; }.CodeMirror-crosshair { cursor: crosshair; }.CodeMirror-line::selection, .CodeMirror-line > span::selection, .CodeMirror-line > span > span::selection { background: #d7d4f0; }.CodeMirror-line::-moz-selection, .CodeMirror-line > span::-moz-selection, .CodeMirror-line > span > span::-moz-selection { background: #d7d4f0; }.cm-searching {background: #ffa; background: rgba(255, 255, 0, .4);}.cm-force-border { padding-right: .1px; }@media print { .CodeMirror div.CodeMirror-cursors {visibility: hidden;}}.cm-tab-wrap-hack:after { content: ""; }span.CodeMirror-selectedtext { background: none; }.CodeMirror-activeline-background, .CodeMirror-selected {transition: visibility 0ms 100ms;}.CodeMirror-blur .CodeMirror-activeline-background, .CodeMirror-blur .CodeMirror-selected {visibility:hidden;}.CodeMirror-blur .CodeMirror-matchingbracket {color:inherit !important;outline:none !important;text-decoration:none !important;}.CodeMirror-sizer {min-height:auto !important;}</style>

# 锁定依赖版本

内容

* [启用配置锁定](#enabling_locking_on_configurations)
* [生成和更新依赖关系锁](#generating_and_updating_dependency_locks)
* [锁定状态的位置和格式](#lock_state_location_and_format)
* [在存在锁定状态的情况下运行构建](#running_a_build_with_lock_state_present)
* [有选择地更新锁定状态条目](#selectively_updating_lock_state_entries)
* [禁用依赖项锁定](#disabling_dependency_locking)
* [每个项目一个锁文件](#single_lock_file_per_project)
* [从锁定状态忽略特定的依赖关系](#ignoring_dependencies)
* [锁定限制](#locking_limitations)
* [星云锁定插件](#nebula_locking_plugin)

使用动态依赖项版本（例如`1.+`或`[1.0,2.0)`）会使构建不确定。这会导致构建崩溃而没有任何明显的变化，更糟糕的是，可能是由构建作者无法控制的传递依赖导致的。

为了实现可[复制的构建](https://reproducible-builds.org/)，必须_锁定_依赖项和传递性依赖项的版本，以便具有相同输入的构建将始终解析相同的模块版本。这称为_依赖锁定_。

除其他外，它启用以下方案：

* 处理多个存储库的公司不再需要依赖`-SNAPSHOT`或更改依赖关系，当依赖关系引入错误或不兼容时，有时会导致级联失败。现在，可以针对主要或次要版本范围声明依赖关系，从而可以在CI上测试最新版本，同时利用锁定来稳定开发人员构建。
* 希望始终使用最新依赖关系的团队可以使用动态版本，仅针对发行版锁定其依赖关系。release标签将包含锁定状态，从而允许在需要开发错误修复程序时完全复制该内部版本。

与[发布已解析的版本]()结合使用，您还可以在发布时替换声明的动态版本部分。消费者将看到您的发行版已解决的版本。

每个[依赖项配置]()均启用锁定。启用后，您必须创建一个初始锁定状态。这将使Gradle验证分辨率结果是否保持不变，即使生成了新版本，也会导致选择的依赖项相同。对构建的修改将影响已解决的依赖关系集，将导致其失败。这样可以确保发布的依赖项或构建定义中的更改不会在不调整锁定状态的情况下更改分辨率。

<table style="background:none;width:912px;"><tbody><tr><td class="icon" style="color:rgba(0, 0, 0, 0.8);width:80px;"><i class="fa icon-note"></i></td><td class="content" style="font-size:1.0625rem;color:rgba(0, 0, 0, 0.6);"><div class="paragraph"><p style="font-size: 1rem;"><font><font>依赖锁定仅在</font></font><a href="" style="color:rgb(29, 162, 189);text-decoration:none;"><font><font>动态版本中</font></font></a><font><font>才有意义</font><font>。</font><font>尽管内容可能会更改，但对坐标不变的</font></font><a href="" style="color:rgb(29, 162, 189);text-decoration:none;"><font><font>版本</font></font></a><font><font>（如</font></font><code style="font-family:Inconsolata, monospace;font-size:0.9375rem;color:rgba(0, 0, 0, 0.9);background-color:rgb(247, 247, 248);">-SNAPSHOT</code><font><font>）</font><font>不会产生影响</font><font>。</font><font>当解决方案结果中存在持久的锁定状态和变化的依赖性时，Gradle甚至会发出警告。</font></font></p></div></td></tr></tbody></table>

## [](#enabling_locking_on_configurations)[启用配置锁定](#enabling_locking_on_configurations)

锁定配置是通过[ResolutionStrategy进行的]()：

示例1.锁定特定配置

`Groovy``Kotlin`

build.gradle

configurations \{ compileClasspath \{ resolutionStrategy.activateDependencyLocking\(\) \} \}

 

1

configurations \{

2

 compileClasspath \{

3

 resolutionStrategy.activateDependencyLocking\(\)

4

 \}

5

\}

或以下方法，作为锁定所有配置的一种方法：

例子2.锁定所有配置

`Groovy``Kotlin`

build.gradle

dependencyLocking \{ lockAllConfigurations\(\) \}

 

1

dependencyLocking \{

2

 lockAllConfigurations\(\)

3

\}

<table style="background:none;width:912px;"><tbody><tr><td class="icon" style="color:rgba(0, 0, 0, 0.8);width:80px;"><i class="fa icon-note"></i></td><td class="content" style="font-size:1.0625rem;color:rgba(0, 0, 0, 0.6);"><div class="paragraph"><p style="font-size: 1rem;"><font><font>仅可解析的配置将具有锁定状态。</font><font>在不可解析的配置上应用锁定只是一个禁忌。</font></font></p></div></td></tr></tbody></table>

<table style="background:none;width:912px;"><tbody><tr><td class="icon" style="color:rgba(0, 0, 0, 0.8);width:80px;"><i class="fa icon-note"></i></td><td class="content" style="font-size:1.0625rem;color:rgba(0, 0, 0, 0.6);"><div class="paragraph"><p style="font-size: 1rem;"><font><font>上面的代码将锁定所有</font></font><em style="font-style:italic;"><font><font>项目</font></font></em><font><font>配置，但不会</font><font>锁定</font></font><em style="font-style:italic;"><font><font>buildscript</font></font></em><font><font>配置</font><font>。</font></font></p></div></td></tr></tbody></table>

您还可以禁用对特定配置的锁定。如果某个插件配置为锁定所有配置，但是您碰巧添加了一个不应锁定的插件，则这很有用。

示例3.解锁特定配置

`Groovy``Kotlin`

build.gradle

configurations \{ compileClasspath \{ resolutionStrategy.deactivateDependencyLocking\(\) \} \}

 

1

configurations \{

2

 compileClasspath \{

3

 resolutionStrategy.deactivateDependencyLocking\(\)

4

 \}

5

\}

### [](#locking_buildscript_classpath_configuration)[锁定buildscript类路径配置](#locking_buildscript_classpath_configuration)

如果将插件应用于构建，则可能还需要利用依赖锁定。为了锁定用于脚本插件的[`classpath`配置]()，请执行以下操作：

例子4.锁定buildscript类路径配置

`Groovy``Kotlin`

build.gradle

buildscript \{ configurations.classpath \{ resolutionStrategy.activateDependencyLocking\(\) \} \}

 

1

buildscript \{

2

 configurations.classpath \{

3

 resolutionStrategy.activateDependencyLocking\(\)

4

 \}

5

\}

## [](#generating_and_updating_dependency_locks)[生成和更新依赖关系锁](#generating_and_updating_dependency_locks)

为了生成或更新锁定状态，`--write-locks`除了将触发要解析的配置的常规任务之外，还指定命令行参数。这将导致在该构建执行中为每个已解析的配置创建锁定状态。请注意，如果先前存在锁定状态，则将其覆盖。

### [](#lock_all_configurations_in_one_build_execution)[将所有配置锁定在一个构建执行中](#lock_all_configurations_in_one_build_execution)

锁定多个配置时，您可能希望在单个构建执行过程中一次锁定所有配置。

为此，您有两个选择：

* 运行`gradle dependencies --write-locks`。这将有效地锁定所有启用了锁定的可解析配置。请注意，在多项目设置中，`dependencies`仅在_一个_项目上执行，在本例中为根。
* 声明将解决所有配置的自定义任务

例子5.解决所有配置

`Groovy``Kotlin`

build.gradle

task resolveAndLockAll \{ doFirst \{ assert gradle.startParameter.writeDependencyLocks \} doLast \{ configurations.findAll \{ // Add any custom filtering on the configurations to be resolved it.canBeResolved \}.each \{ it.resolve\(\) \} \} \}

 

1

task resolveAndLockAll \{

2

 doFirst \{

3

 assert gradle.startParameter.writeDependencyLocks

4

 \}

5

 doLast \{

6

 configurations.findAll \{

7

 // Add any custom filtering on the configurations to be resolved

8

 it.canBeResolved

9

 \}.each \{ it.resolve\(\) \}

10

 \}

11

\}

第二种选择是，通过正确选择配置，可以成为本机环境中的唯一选择，在这种情况下，并非所有配置都可以在单个平台上解决。

## [](#lock_state_location_and_format)[锁定状态的位置和格式](#lock_state_location_and_format)

锁定状态将保留在`gradle/dependency-locks`项目或子项目目录内的文件夹中的文件中。每个文件均由其锁定的配置命名，并具有`lockfile`扩展名。该规则的一个例外是构建[脚本本身的]()配置。在这种情况下，配置名称将带有前缀`buildscript-`。

文件的内容是每行的模块表示法，标题提供了一些上下文。模块符号按字母顺序排序，以简化差异。

gradle / dependency-locks / compileClasspath.lockfile

＃这是Gradle生成的用于依赖项锁定的文件。 ＃手动编辑会中断构建，因此不建议使用。 ＃此文件应为源代码管理的一部分。 org.springframework：spring-beans：5.0.5.RELEASE org.springframework：spring-core：5.0.5.RELEASE org.springframework：spring-jcl：5.0.5.RELEASE

匹配以下依赖项声明：

例子6.动态依赖声明

`Groovy``Kotlin`

build.gradle

dependencies \{ implementation 'org.springframework:spring-beans:\[5.0,6.0\)' \}

 

1

dependencies \{

2

 implementation 'org.springframework:spring-beans:\[5.0,6.0\)'

3

\}

## [](#running_a_build_with_lock_state_present)[在存在锁定状态的情况下运行构建](#running_a_build_with_lock_state_present)

构建需要解析启用了锁定的配置并找到匹配的锁定状态时，它将使用它来验证给定的配置仍解析相同的版本。

成功的构建表明使用了与锁定状态中存储的依赖项相同的依赖项，无论是否已生成与动态选择器匹配的新版本。

完整的验证如下：

* 处于锁定状态的现有条目必须在构建中匹配  

  * 版本不匹配或缺少已解决的模块会导致构建失败
* 与锁定状态相比，解析结果不得包含其他依赖项

### [](#fine_tuning_dependency_locking_behaviour_with_lock_mode)[使用锁定模式微调依赖项锁定行为](#fine_tuning_dependency_locking_behaviour_with_lock_mode)

虽然默认锁定模式的行为如上所述，但是还有其他两种模式可用：

严格模式

在这种模式下，在除上述验证，依赖锁定如果将标记为失败的配置_锁定_不具有与之相关联的锁定状态。

宽容模式

在此模式下，依存关系锁定仍将固定动态版本，但对依存关系分辨率的更改不再是错误。

锁定模式可以从`dependencyLocking`块中进行控制，如下所示：

例子7.设置锁定模式

`Groovy``Kotlin`

build.gradle

dependencyLocking \{ lockMode = LockMode.STRICT \}

 

1

dependencyLocking \{

2

 lockMode \= LockMode.STRICT

3

\}

## [](#selectively_updating_lock_state_entries)[有选择地更新锁定状态条目](#selectively_updating_lock_state_entries)

为了仅更新配置的特定模块，可以使用`--update-locks`命令行标志。它以逗号（`,`）分隔的模块符号列表。在这种模式下，现有的锁定状态仍将用作解决方案的输入，从而过滤出更新目标模块。

❯gradle类--update-locks org.apache.commons：commons-lang3，org.slf4j：slf4j-api

用表示的通配符`*`可以在组名或模块名中使用。它们可以是唯一字符，也可以分别出现在组或模块的末尾。以下通配符表示法示例有效：

* `org.apache.commons:*`：将让属于组的所有模块`org.apache.commons`更新
* `*:guava`：将让所有名为的模块`guava`（无论其组如何）进行更新
* `org.springframework.spring*:spring*`：将让所有模块以其组开头，`org.springframework.spring`名称以`spring`update开头

<table style="background:none;width:912px;"><tbody><tr><td class="icon" style="color:rgba(0, 0, 0, 0.8);width:80px;"><i class="fa icon-note"></i></td><td class="content" style="font-size:1.0625rem;color:rgba(0, 0, 0, 0.6);"><div class="paragraph"><p style="font-size: 1rem;"><font><font>分辨率可能会导致其他模块版本更新，这取决于Gradle分辨率规则。</font></font></p></div></td></tr></tbody></table>

## [](#disabling_dependency_locking)[禁用依赖项锁定](#disabling_dependency_locking)

1.  确保不再需要锁定的配置未配置锁定。
2.  删除与不再需要锁定的配置相匹配的文件。

如果仅执行上面的第二步，则锁定将不再有效。但是，如果将来在锁定状态持续存在时解决该配置，它将再次被锁定。

## [](#single_lock_file_per_project)[每个项目一个锁文件](#single_lock_file_per_project)

Gradle支持改进的锁定文件格式。目标是每个项目只有一个锁定文件，其中包含该项目所有配置的锁定状态。默认情况下，该文件被命名`gradle.lockfile`并位于项目目录中。构建脚本本身的锁定状态可`buildscript-gradle.lockfile`在项目目录内名为的文件中找到。

与每个锁配置需要一个锁文件的格式相比，锁的主要好处是可以大大减少锁文件的数量。

此格式需要迁移现有的锁定用户，因此可以选择加入。

<table style="background:none;width:912px;"><tbody><tr><td class="icon" style="color:rgba(0, 0, 0, 0.8);width:80px;"><i class="fa icon-note"></i></td><td class="content" style="font-size:1.0625rem;color:rgba(0, 0, 0, 0.6);"><div class="paragraph"><p style="font-size: 1rem;"><font><font>目标是在Gradle 7.0中默认为每个项目使用此单个锁定文件。</font></font></p></div></td></tr></tbody></table>

可以通过启用匹配[功能预览]()来激活格式：

例子8.每个项目激活一个锁文件

`Groovy``Kotlin`

settings.gradle

rootProject.name = 'locking-single-file' enableFeaturePreview\('ONE\_LOCKFILE\_PER\_PROJECT'\)

 

1

rootProject.name \= 'locking-single-file'

2

3

enableFeaturePreview\('ONE\_LOCKFILE\_PER\_PROJECT'\)

然后使用以下依赖项声明和锁定的配置：

例子9.显式锁定

`Groovy``Kotlin`

build.gradle

configurations \{ compileClasspath \{ resolutionStrategy.activateDependencyLocking\(\) \} runtimeClasspath \{ resolutionStrategy.activateDependencyLocking\(\) \} annotationProcessor \{ resolutionStrategy.activateDependencyLocking\(\) \} \} dependencies \{ implementation 'org.springframework:spring-beans:\[5.0,6.0\)' \}

 

1

configurations \{

2

 compileClasspath \{

3

 resolutionStrategy.activateDependencyLocking\(\)

4

 \}

5

 runtimeClasspath \{

6

 resolutionStrategy.activateDependencyLocking\(\)

7

 \}

8

 annotationProcessor \{

9

 resolutionStrategy.activateDependencyLocking\(\)

10

 \}

11

\}

12

13

dependencies \{

14

 implementation 'org.springframework:spring-beans:\[5.0,6.0\)'

15

\}

锁定文件将具有以下内容：

gradle.lockfile

＃这是Gradle生成的用于依赖项锁定的文件。 ＃手动编辑会中断构建，因此不建议使用。 ＃此文件应为源代码管理的一部分。 org.springframework：spring-beans：5.0.5.RELEASE = compileClasspath，runtimeClasspath org.springframework：spring-core：5.0.5.RELEASE = compileClasspath，runtimeClasspath org.springframework：spring-jcl：5.0.5.RELEASE = compileClasspath，runtimeClasspath empty = annotationProcessor

* 每行在表示`group:artifact:version`法中仍然代表一个依赖项
* 然后列出所有包含给定依赖性的配置
* 文件的最后一行列出了所有空配置，即已知没有依赖性的配置

### [](#migrating_to_the_single_lockfile_per_project_format)[迁移到每个项目格式的单个锁定文件](#migrating_to_the_single_lockfile_per_project_format)

一旦激活了功能预览（参见上文），您就可以简单地按照文档来[编写](#lock_all_configurations_in_one_build_execution)或[更新](#selectively_updating_lock_state_entries)依赖项锁定状态。

然后，在确认每个项目的单个锁定文件包含给定配置的锁定状态之后，可以从中删除匹配的每个配置锁定文件`gradle/dependency-locks`。

### [](#configuring_the_per_project_lock_file_name_and_location)[配置每个项目的锁定文件名和位置](#configuring_the_per_project_lock_file_name_and_location)

在每个项目中使用单个锁定文件时，可以配置其名称和位置。提供此功能的主要原因是使文件名可以由某些项目属性确定，从而有效地允许单个项目为不同的执行上下文存储不同的锁定状态。JVM生态系统中的一个简单示例是Scala版本，该版本通常在工件坐标中找到。

例子10.改变锁文件名

`Groovy``Kotlin`

build.gradle

def scalaVersion = "2.12" dependencyLocking \{ lockFile = file\("\$projectDir/locking/gradle-\$\{scalaVersion\}.lockfile"\) \}

 

1

def scalaVersion \= "2.12"

2

dependencyLocking \{

3

 lockFile \= file\("\$projectDir/locking/gradle-\$\{scalaVersion\}.lockfile"\)

4

\}

## [](#ignoring_dependencies)[从锁定状态忽略特定的依赖关系](#ignoring_dependencies)

在重现性不是主要目标的情况下，可以使用依赖项锁定。作为构建作者，您可能希望依赖版本更新的频率有所不同，例如，取决于它们的来源。在这种情况下，忽略某些依赖项可能很方便，因为您始终想使用最新版本。一个示例是组织中的内部依赖关系，该内部依赖关系应始终使用最新版本，而不是第三方依赖关系，后者具有不同的升级周期。

<table style="background:none;width:912px;"><tbody><tr><td class="icon" style="color:rgba(0, 0, 0, 0.8);width:80px;"><i class="fa icon-warning"></i></td><td class="content" style="font-size:1.0625rem;color:rgba(0, 0, 0, 0.6);"><div class="paragraph"><p style="font-size: 1rem;"><font><font>此功能可能会破坏可重复性，应谨慎使用。</font><font>在某些情况下，最好利用<span>&nbsp;</span></font></font><a href="#fine_tuning_dependency_locking_behaviour_with_lock_mode" style="color:rgb(29, 162, 189);text-decoration:none;"><font><font>不同的锁定模式</font></font></a><font><font>或</font></font><a href="#configuring_the_per_project_lock_file_name_and_location" style="color:rgb(29, 162, 189);text-decoration:none;"><font><font>对锁定文件使用不同的名称</font></font></a><font><font>。</font></font></p></div></td></tr></tbody></table>

您可以在`dependencyLocking`项目扩展中配置忽略的依赖项：

例子11.忽略锁定状态的依赖性

`Groovy``Kotlin`

build.gradle

dependencyLocking \{ ignoredDependencies.add\('com.example:\*'\) \}

 

1

dependencyLocking \{

2

 ignoredDependencies.add\('com.example:\*'\)

3

\}

该表示法是一种`<group>:<name>`依赖关系表示法，`*`可在其中用作尾随通配符。有关更多详细信息，请参见有关更新锁定文件[的描述](#selectively_updating_lock_state_entries)。请注意，该值`*:*`不被接受，因为它等同于禁用锁定。

忽略依赖项将具有以下效果：

* 忽略的依赖性适用于所有锁定的配置。该设置是项目范围的。
* 忽略依赖项并不意味着锁状态会忽略其传递性依赖项。
* 没有验证任何配置解析中都存在被忽略的依赖项。
* 如果依赖项处于锁定状态，则加载它会过滤掉该依赖项。
* 如果解析结果中存在依赖项，则在验证分辨率与锁定状态匹配时将忽略该依赖项。
* 最后，如果在解决方案结果中存在依赖性并且锁定状态持续存在，则写入的锁定状态将不存在该依赖性。

## [](#locking_limitations)[锁定限制](#locking_limitations)

* 锁定尚不能应用于源依赖项。

## [](#nebula_locking_plugin)[星云锁定插件](#nebula_locking_plugin)

此功能受[Nebula Gradle依赖项锁定插件的](https://github.com/nebula-plugins/gradle-dependency-lock-plugin)启发。